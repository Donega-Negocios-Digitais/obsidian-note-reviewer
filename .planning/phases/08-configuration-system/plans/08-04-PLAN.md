---
phase: 08-configuration-system
plan: 04
type: execute
wave: 1
depends_on: ["08-01"]
files_modified:
  - apps/portal/src/components/PromptTemplateEditor.tsx
  - apps/portal/src/pages/Settings.tsx
autonomous: false

must_haves:
  truths:
    - "User can customize Claude Code prompt template"
    - "Template supports variable placeholders"
    - "Template persists to localStorage"
    - "Editor shows available variables"
    - "Preview of rendered template"
  artifacts:
    - path: "apps/portal/src/components/PromptTemplateEditor.tsx"
      provides: "Prompt template editor component"
      exports: ["PromptTemplateEditor"]
      min_lines: 150

<objective>
Build customizable prompt template editor for Claude Code integration.

**Purpose:** Deliver CONF-04 requirement - customizable Claude Code prompt template.

**Output:** Complete prompt template editor with variable support and preview.
</objective>

<tasks>

<task type="auto">
  <name>Create PromptTemplateEditor component</name>
  <files>apps/portal/src/components/PromptTemplateEditor.tsx</files>
  <action>
    Create `apps/portal/src/components/PromptTemplateEditor.tsx`:

    ```typescript
    /**
     * Prompt Template Editor Component
     *
     * Editor for customizing Claude Code prompt template.
     */

    import React, { useState, useCallback, useMemo } from 'react';

    export interface TemplateVariable {
      name: string;
      description: string;
      example: string;
    }

    export interface PromptTemplateEditorProps {
      template: string;
      onChange: (template: string) => void;
      variables?: TemplateVariable[];
      onSave?: () => void;
      readOnly?: boolean;
    }

    const DEFAULT_VARIABLES: TemplateVariable[] = [
      { name: '{{content}}', description: 'Conte√∫do do documento', example: 'Markdown content...' },
      { name: '{{annotations}}', description: 'Anota√ß√µes atuais', example: '- Issue on line 5' },
      { name: '{{title}}', description: 'T√≠tulo do documento', example: 'My Document.md' },
      { name: '{{context}}', description: 'Contexto adicional', example: 'Project notes' },
    ];

    /**
     * Render template with sample values for preview
     */
    function renderPreview(template: string, variables: TemplateVariable[]): string {
      let preview = template;

      variables.forEach((variable) => {
        preview = preview.replace(new RegExp(variable.name, 'g'), variable.example);
      });

      return preview;
    }

    /**
     * Prompt template editor with variable suggestions
     */
    export function PromptTemplateEditor({
      template,
      onChange,
      variables = DEFAULT_VARIABLES,
      onSave,
      readOnly = false,
    }: PromptTemplateEditorProps) {
      const [showVariables, setShowVariables] = useState(false);
      const [cursorPosition, setCursorPosition] = useState(0);

      // Calculate line count
      const lineCount = template.split('\n').length;

      // Render preview
      const preview = useMemo(() => renderPreview(template, variables), [template, variables]);

      /**
       * Insert variable at cursor position
       */
      const insertVariable = useCallback((variable: string) => {
        const before = template.substring(0, cursorPosition);
        const after = template.substring(cursorPosition);
        onChange(before + variable + after);
        setShowVariables(false);
      }, [template, cursorPosition, onChange]);

      /**
       * Handle textarea input and track cursor
       */
      const handleInput = useCallback((e: React.ChangeEvent<HTMLTextAreaElement>) => {
        onChange(e.target.value);
        setCursorPosition(e.target.selectionStart);
      }, [onChange]);

      return (
        <div className="prompt-template-editor space-y-4">
          {/* Toolbar */}
          <div className="flex items-center justify-between">
            <div className="flex items-center gap-2">
              <label className="text-sm font-medium text-gray-700 dark:text-gray-300">
                Template do Prompt
              </label>
              <button
                onClick={() => setShowVariables(!showVariables)}
                className="px-2 py-1 text-xs bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 rounded text-gray-700 dark:text-gray-300 transition-colors"
              >
                {showVariables ? 'Ocultar' : 'Vari√°veis'}
              </button>
            </div>
            {onSave && (
              <button
                onClick={onSave}
                className="px-3 py-1.5 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
              >
                Salvar
              </button>
            )}
          </div>

          {/* Variable suggestions */}
          {showVariables && (
            <div className="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
              <p className="text-xs font-medium text-blue-800 dark:text-blue-300 mb-2">
                Clique para inserir vari√°vel:
              </p>
              <div className="flex flex-wrap gap-2">
                {variables.map((variable) => (
                  <button
                    key={variable.name}
                    onClick={() => insertVariable(variable.name)}
                    className="px-2 py-1 text-xs bg-white dark:bg-gray-800 border border-blue-200 dark:border-blue-700 rounded text-blue-700 dark:text-blue-300 hover:bg-blue-100 dark:hover:bg-blue-900/30 transition-colors"
                    title={variable.description}
                  >
                    {variable.name}
                  </button>
                ))}
              </div>
            </div>
          )}

          {/* Editor */}
          <div className="relative">
            <textarea
              value={template}
              onChange={handleInput}
              onSelect={(e) => setCursorPosition(e.target.selectionStart)}
              readOnly={readOnly}
              rows={Math.max(lineCount, 8)}
              className={`
                w-full px-4 py-3 font-mono text-sm bg-gray-50 dark:bg-gray-900
                border border-gray-300 dark:border-gray-600 rounded-lg
                focus:ring-2 focus:ring-blue-500 focus:border-transparent
                ${readOnly ? 'cursor-not-allowed opacity-70' : ''}
              `}
              placeholder="Digite seu template de prompt aqui..."
            />
          </div>

          {/* Variable reference */}
          <div className="text-xs text-gray-500 dark:text-gray-400">
            <p className="font-medium mb-1">Vari√°veis dispon√≠veis:</p>
            <ul className="space-y-1">
              {variables.map((variable) => (
                <li key={variable.name}>
                  <code className="px-1 py-0.5 bg-gray-200 dark:bg-gray-700 rounded">
                    {variable.name}
                  </code>
                  <span className="ml-1">- {variable.description}</span>
                </li>
              ))}
            </ul>
          </div>

          {/* Preview */}
          <div>
            <p className="text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Preview:
            </p>
            <div className="p-4 bg-gray-100 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
              <pre className="text-sm text-gray-800 dark:text-gray-200 whitespace-pre-wrap font-sans">
                {preview || '(seu template aparecer√° aqui)'}
              </pre>
            </div>
          </div>
        </div>
      );
    }

    /**
     * Compact prompt template viewer
     */
    export interface PromptTemplateViewerProps {
      template: string;
      onEdit?: () => void;
    }

    export function PromptTemplateViewer({ template, onEdit }: PromptTemplateViewerProps) {
      const preview = useMemo(() => renderPreview(template, DEFAULT_VARIABLES), [template]);

      return (
        <div className="prompt-template-viewer">
          <div className="flex items-center justify-between mb-2">
            <h4 className="text-sm font-medium text-gray-700 dark:text-gray-300">
              Template Atual
            </h4>
            {onEdit && (
              <button
                onClick={onEdit}
                className="text-xs text-blue-600 dark:text-blue-400 font-medium hover:underline"
              >
                Editar
              </button>
            )}
          </div>
          <div className="p-3 bg-gray-100 dark:bg-gray-800 rounded-lg border border-gray-200 dark:border-gray-700">
            <pre className="text-xs text-gray-800 dark:text-gray-200 whitespace-pre-wrap font-sans max-h-32 overflow-auto">
              {template}
            </pre>
          </div>
        </div>
      );
    }

    export default PromptTemplateEditor;
    ```

    Save to `apps/portal/src/components/PromptTemplateEditor.tsx`.
  </action>
  <verify>PromptTemplateEditor component created</verify>
  <done>Prompt template editor</done>
</task>

<task type="auto">
  <name>Integrate prompt editor into Settings</name>
  <files>apps/portal/src/pages/Settings.tsx</files>
  <action>
    Update `apps/portal/src/pages/Settings.tsx` to integrate prompt template editor:

    1. Import components:
    ```typescript
    import { PromptTemplateEditor } from '../components/PromptTemplateEditor';
    import { useState, useEffect } from 'react';
    ```

    2. Add prompt template state:
    ```typescript
    const DEFAULT_PROMPT_TEMPLATE = `Por favor, revise o seguinte documento:

T√≠tulo: {{title}}
{{content}}

Anota√ß√µes existentes:
{{annotations}}

{{context}}

Por favor, forne√ßa feedback construtivo e sugest√µes de melhoria.`;

    // In component
    const [promptTemplate, setPromptTemplate] = useState(() => {
      const saved = localStorage.getItem('obsreview-prompt-template');
      return saved || DEFAULT_PROMPT_TEMPLATE;
    });

    const [isEditingPrompt, setIsEditingPrompt] = useState(false);
    ```

    3. Update IntegrationSettings component:
    ```typescript
    function IntegrationSettings() {
      const [promptTemplate, setPromptTemplate] = useState(DEFAULT_PROMPT_TEMPLATE);
      const [isEditingPrompt, setIsEditingPrompt] = useState(false);

      const handleSavePrompt = () => {
        localStorage.setItem('obsreview-prompt-template', promptTemplate);
        setIsEditingPrompt(false);
      };

      return (
        <div>
          <h2 className="text-2xl font-semibold text-gray-900 dark:text-white mb-6">
            Integra√ß√£o
          </h2>

          <SettingsSection>
            <SettingsItem
              title="Claude Code"
              description="Configurar integra√ß√£o com Claude Code"
              icon="ü§ñ"
              action={
                <button className="text-sm text-blue-600 dark:text-blue-400 font-medium">
                  Conectado
                </button>
              }
            />
            <SettingsToggle
              label="Hook autom√°tico"
              description="Abrir revisor automaticamente ao criar nota"
              checked={true}
              onChange={() => {}}
              icon="‚ö°"
            />
          </SettingsSection>

          <SettingsSection title="Template do Prompt">
            {isEditingPrompt ? (
              <PromptTemplateEditor
                template={promptTemplate}
                onChange={setPromptTemplate}
                onSave={handleSavePrompt}
              />
            ) : (
              <SettingsItem
                title="Template personalizado"
                description="Customizar o prompt enviado ao Claude Code"
                icon="üìù"
                action={
                  <button
                    onClick={() => setIsEditingPrompt(true)}
                    className="text-sm text-blue-600 dark:text-blue-400 font-medium"
                  >
                    Editar
                  </button>
                }
              >
                <div className="mt-2 p-3 bg-gray-100 dark:bg-gray-800 rounded text-sm text-gray-700 dark:text-gray-300 max-h-32 overflow-auto">
                  {promptTemplate}
                </div>
              </SettingsItem>
            )}
          </SettingsSection>
        </div>
      );
    }
    ```

    This integrates the prompt template editor into settings.
  </action>
  <verify>Prompt editor integrated into settings</verify>
  <done>Integrated prompt editor</done>
</task>

</tasks>

<verification>
- [ ] PromptTemplateEditor with textarea
- [ ] Variable suggestions with insert
- [ ] Preview of rendered template
- [ ] Template persists to localStorage
- [ ] Edit/Save workflow
- [ ] Settings integration
</verification>

<success_criteria>
1. Prompt template customizable (CONF-04)
2. Variable placeholders supported
3. Template persists across sessions
4. Preview shows rendered output
</success_criteria>

---

**Plan created:** 2026-02-06
**Estimated duration:** 20 min
**Complexity:** Medium (template editing, variable replacement, preview)

---
phase: 05-real-time-collaboration
plan: 03
type: execute
wave: 2
depends_on: ["05-02"]
files_modified:
  - apps/portal/src/pages/SharedDocument.tsx
  - apps/portal/src/components/GuestBanner.tsx
  - packages/collaboration/src/types.ts
autonomous: false

must_haves:
  truths:
    - "Guest users can view shared documents without login"
    - "Guest users see banner prompting them to sign up"
    - "Document content is visible to guests"
    - "Annotations are visible to guests (read-only)"
  artifacts:
    - path: "apps/portal/src/pages/SharedDocument.tsx"
      provides: "Guest-accessible shared document page"
      min_lines: 150
    - path: "apps/portal/src/components/GuestBanner.tsx"
      provides: "Banner encouraging guests to sign up"
      min_lines: 50
  key_links:
    - from: "apps/portal/src/pages/SharedDocument.tsx"
      to: "apps/portal/src/components/DocumentViewer.tsx"
      via: "import"
      pattern: "DocumentViewer"

<objective>
Implement guest access for viewing shared reviews without authentication requirement.

**Purpose:** Deliver COLL-04 requirement - guest users can view shared reviews.

**Output:** Complete guest access flow with shared document page.
</objective>

<context>
@.planning/phases/05-real-time-collaboration/05-CONTEXT.md
@apps/portal/src/components/DocumentViewer.tsx

Guest access requirements:
- No authentication required to view
- Read-only access to annotations
- Banner encouraging sign up for full features
- Share link format: /shared/{slug}
</context>

<tasks>

<task type="auto">
  <name>Add guest access types</name>
  <files>packages/collaboration/src/types.ts</files>
  <action>
    Add to `packages/collaboration/src/types.ts`:

    ```typescript
    export interface SharedDocumentAccess {
      documentId: string;
      slug: string;
      isGuest: boolean;
      canEdit: boolean;
      canComment: boolean;
    }
    ```
  </action>
  <verify>types.ts exports SharedDocumentAccess</verify>
  <done>Guest access type definitions</done>
</task>

<task type="auto">
  <name>Create GuestBanner component</name>
  <files>apps/portal/src/components/GuestBanner.tsx</files>
  <action>
    Create `apps/portal/src/components/GuestBanner.tsx`:

    ```typescript
    /**
     * Guest Banner Component
     *
     * Banner shown to guest users encouraging them to sign up.
     */

    import React from 'react';
    import { useNavigate } from 'react-router-dom';

    export interface GuestBannerProps {
      className?: string;
    }

    export function GuestBanner({ className = '' }: GuestBannerProps) {
      const navigate = useNavigate();

      return (
        <div className={`bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-3 ${className}`}>
          <div className="flex items-center justify-between gap-4">
            <div className="flex items-center gap-3">
              <svg className="w-6 h-6 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
              </svg>
              <div>
                <p className="font-medium">Visualizando como visitante</p>
                <p className="text-sm text-blue-100">
                  Crie uma conta gratuita para anotar, comentar e colaborar
                </p>
              </div>
            </div>

            <button
              onClick={() => navigate('/auth/signup')}
              className="px-4 py-2 bg-white text-blue-600 font-medium rounded-lg hover:bg-blue-50 transition-colors whitespace-nowrap"
            >
              Criar Conta Grátis
            </button>
          </div>
        </div>
      );
    }

    export default GuestBanner;
    ```
  </action>
  <verify>GuestBanner displays signup CTA</verify>
  <done>Guest banner component</done>
</task>

<task type="auto">
  <name>Create SharedDocument page</name>
  <files>apps/portal/src/pages/SharedDocument.tsx</files>
  <action>
    Create `apps/portal/src/pages/SharedDocument.tsx`:

    ```typescript
    /**
     * Shared Document Page
     *
     * Guest-accessible page for viewing shared documents.
     */

    import React, { useState, useEffect } from 'react';
    import { useParams, useNavigate } from 'react-router-dom';
    import { GuestBanner } from '../components/GuestBanner';
    import { DocumentViewer } from '../components/DocumentViewer';
    import { usePresence } from '../hooks/usePresence';

    export function SharedDocument() {
      const { slug } = useParams<{ slug: string }>();
      const navigate = useNavigate();
      const [document, setDocument] = useState<any>(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState<string | null>(null);
      const [isGuest, setIsGuest] = useState(true);

      const { others, connected } = usePresence({
        roomId: slug ? `shared-${slug}` : '',
        enabled: !!slug && !error,
      });

      useEffect(() => {
        if (!slug) {
          setError('Link inválido');
          setLoading(false);
          return;
        }

        // TODO: Fetch document by slug from API
        const fetchDocument = async () => {
          try {
            setLoading(true);
            // Mock document for now
            setDocument({
              id: 'mock-doc',
              title: 'Documento Compartilhado',
              content: '# Conteúdo do Documento\n\nEste é um exemplo de documento compartilhado.',
              annotations: [],
            });
          } catch (err) {
            setError('Documento não encontrado ou link expirou');
          } finally {
            setLoading(false);
          }
        };

        fetchDocument();
      }, [slug]);

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4" />
              <p className="text-gray-600 dark:text-gray-400">Carregando documento...</p>
            </div>
          </div>
        );
      }

      if (error || !document) {
        return (
          <div className="min-h-screen flex items-center justify-center p-4">
            <div className="text-center max-w-md">
              <div className="w-16 h-16 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg className="w-8 h-8 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
              </div>
              <h1 className="text-xl font-semibold text-gray-900 dark:text-white mb-2">
                Documento Não Encontrado
              </h1>
              <p className="text-gray-600 dark:text-gray-400 mb-6">
                {error || 'Este link pode ter expirado ou o documento não existe.'}
              </p>
              <button
                onClick={() => navigate('/')}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
              >
                Voltar ao Início
              </button>
            </div>
          </div>
        );
      }

      return (
        <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
          {/* Guest Banner */}
          {isGuest && <GuestBanner />}

          {/* Header */}
          <header className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
            <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
              <div>
                <h1 className="text-xl font-semibold text-gray-900 dark:text-white">
                  {document.title}
                </h1>
                <p className="text-sm text-gray-500 dark:text-gray-400">
                  Compartilhado com você
                </p>
              </div>

              {/* Presence */}
              {slug && connected && others.length > 0 && (
                <div className="text-sm text-gray-600 dark:text-gray-400">
                  {others.length} {others.length === 1 ? 'outro' : 'outros'} visualizando
                </div>
              )}
            </div>
          </header>

          {/* Document Content */}
          <main className="max-w-7xl mx-auto px-4 py-8">
            <DocumentViewer
              document={document}
              readOnly={isGuest}
              annotations={document.annotations || []}
            />
          </main>
        </div>
      );
    }

    export default SharedDocument;
    ```
  </action>
  <verify>SharedDocument page renders guest view</verify>
  <done>Shared document page component</done>
</task>

<task type="auto">
  <name>Add shared document route</name>
  <files>apps/portal/src/App.tsx</files>
  <action>
    Add route to App.tsx routing:

    ```typescript
    import { SharedDocument } from './pages/SharedDocument';

    // In routes:
    <Route path="/shared/:slug" element={<SharedDocument />} />
    ```

    NOTE: This route should be PUBLIC (no authentication required).
  </action>
  <verify>/shared/:slug route exists without auth requirement</verify>
  <done>Public shared document route</done>
</task>

</tasks>

<verification>
- [ ] SharedDocumentAccess type defined
- [ ] GuestBanner component created with signup CTA
- [ ] SharedDocument page fetches and displays document
- [ ] Route /shared/:slug is public (no auth)
- [ ] Presence works for guest users
- [ ] Error handling for invalid/expired links
</verification>

<success_criteria>
1. Guest users can view shared documents (COLL-04)
2. No authentication required
3. Signup banner displayed to guests
</success_criteria>

<output>
After completion, create `.planning/phases/05-real-time-collaboration/plans/05-03-SUMMARY.md`
</output>

---

**Plan created:** 2026-02-06
**Estimated duration:** 20 min
**Complexity:** Medium (public routing, guest detection, error handling)

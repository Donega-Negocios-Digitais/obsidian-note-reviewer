---
phase: 09-sharing-infrastructure
plan: 02
type: execute
wave: 1
depends_on: ["05-01", "09-01"]
files_modified:
  - apps/portal/src/hooks/useSharedAnnotations.ts
  - apps/portal/src/components/CollaborativeAnnotationPanel.tsx
  - apps/portal/src/pages/SharedDocument.tsx
autonomous: false

must_haves:
  truths:
    - "Multiple users can annotate shared documents"
    - "Annotations show author information"
    - "Real-time sync of annotations between users"
    - "Conflict resolution for simultaneous edits"
    - "Author avatars and names visible"
  artifacts:
    - path: "apps/portal/src/hooks/useSharedAnnotations.ts"
      provides: "Multi-user annotation management"
      exports: ["useSharedAnnotations"]
      min_lines: 120
    - path: "apps/portal/src/components/CollaborativeAnnotationPanel.tsx"
      provides: "Collaborative annotation display"
      exports: ["CollaborativeAnnotationPanel"]
      min_lines: 150

<objective>
Build multi-user annotation system for shared plans with real-time collaboration.

**Purpose:** Deliver SHAR-02 requirement - multiple users can annotate shared plans collaboratively.

**Output:** Complete collaborative annotation system with real-time sync.
</objective>

<tasks>

<task type="auto">
  <name>Create useSharedAnnotations hook</name>
  <files>apps/portal/src/hooks/useSharedAnnotations.ts</files>
  <action>
    Create `apps/portal/src/hooks/useSharedAnnotations.ts`:

    ```typescript
    /**
     * Shared Annotations Hook
     *
     * Manages annotations for shared documents with multi-user support.
     */

    import { useState, useCallback, useEffect } from 'react';
    import type { Annotation } from '@obsidian-note-reviewer/ui/types';
    import type { User } from '@obsidian-note-reviewer/collaboration/types';

    export interface SharedAnnotation extends Annotation {
      id: string;
      documentId: string;
      authorId: string;
      authorName: string;
      authorColor?: string;
      createdAt: string;
      updatedAt: string;
    }

    export interface UseSharedAnnotationsOptions {
      documentId: string;
      initialAnnotations?: SharedAnnotation[];
      roomId?: string;
    }

    export interface UseSharedAnnotationsReturn {
      annotations: SharedAnnotation[];
      addAnnotation: (annotation: Omit<SharedAnnotation, 'id' | 'createdAt' | 'updatedAt'>) => void;
      updateAnnotation: (id: string, updates: Partial<SharedAnnotation>) => void;
      deleteAnnotation: (id: string) => void;
      resolveAnnotation: (id: string, status: 'open' | 'in-progress' | 'resolved') => void;
      getUserAnnotations: (userId: string) => SharedAnnotation[];
      getAnnotationsByStatus: (status: 'open' | 'in-progress' | 'resolved') => SharedAnnotation[];
    }

    /**
     * Hook for managing shared document annotations
     */
    export function useSharedAnnotations({
      documentId,
      initialAnnotations = [],
      roomId,
    }: UseSharedAnnotationsOptions): UseSharedAnnotationsReturn {
      const [annotations, setAnnotations] = useState<SharedAnnotation[]>(initialAnnotations);

      /**
       * Add new annotation
       */
      const addAnnotation = useCallback((
        annotation: Omit<SharedAnnotation, 'id' | 'createdAt' | 'updatedAt'>
      ) => {
        const newAnnotation: SharedAnnotation = {
          ...annotation,
          id: `anno-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
          documentId,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
        };

        setAnnotations((prev) => [...prev, newAnnotation]);

        // Broadcast to Liveblocks room if available
        if (roomId && typeof window !== 'undefined') {
          // @ts-ignore - Liveblocks integration
          window.broadcastEvent?.({
            type: 'annotation-added',
            annotation: newAnnotation,
          });
        }

        return newAnnotation.id;
      }, [documentId, roomId]);

      /**
       * Update existing annotation
       */
      const updateAnnotation = useCallback((id: string, updates: Partial<SharedAnnotation>) => {
        setAnnotations((prev) =>
          prev.map((anno) =>
            anno.id === id
              ? { ...anno, ...updates, updatedAt: new Date().toISOString() }
              : anno
          )
        );
      }, [roomId]);

      /**
       * Delete annotation
       */
      const deleteAnnotation = useCallback((id: string) => {
        setAnnotations((prev) => prev.filter((anno) => anno.id !== id));
      }, []);

      /**
       * Resolve annotation (change status)
       */
      const resolveAnnotation = useCallback((
        id: string,
        status: 'open' | 'in-progress' | 'resolved'
      ) => {
        updateAnnotation(id, { status });
      }, [updateAnnotation]);

      /**
       * Get annotations by user
       */
      const getUserAnnotations = useCallback((userId: string): SharedAnnotation[] => {
        return annotations.filter((anno) => anno.authorId === userId);
      }, [annotations]);

      /**
       * Get annotations by status
       */
      const getAnnotationsByStatus = useCallback((
        status: 'open' | 'in-progress' | 'resolved'
      ): SharedAnnotation[] => {
        return annotations.filter((anno) => anno.status === status);
      }, [annotations]);

      return {
        annotations,
        addAnnotation,
        updateAnnotation,
        deleteAnnotation,
        resolveAnnotation,
        getUserAnnotations,
        getAnnotationsByStatus,
      };
    }

    /**
     * Transform local annotation to shared annotation
     */
    export function toSharedAnnotation(
      annotation: Annotation,
      user: Pick<User, 'id' | 'name' | 'color'>
    ): Omit<SharedAnnotation, 'id' | 'documentId' | 'createdAt' | 'updatedAt'> {
      return {
        ...annotation,
        authorId: user.id,
        authorName: user.name,
        authorColor: user.color,
      };
    }

    /**
     * Transform shared annotation to local format
     */
    export function fromSharedAnnotation(shared: SharedAnnotation): Annotation {
      const { authorId, authorName, authorColor, documentId, createdAt, updatedAt, ...annotation } = shared;
      return annotation as Annotation;
    }

    export default useSharedAnnotations;
    ```

    Save to `apps/portal/src/hooks/useSharedAnnotations.ts`.
  </action>
  <verify>useSharedAnnotations hook created</verify>
  <done>Shared annotations hook</done>
</task>

<task type="auto">
  <name>Create CollaborativeAnnotationPanel component</name>
  <files>apps/portal/src/components/CollaborativeAnnotationPanel.tsx</files>
  <action>
    Create `apps/portal/src/components/CollaborativeAnnotationPanel.tsx`:

    ```typescript
    /**
     * Collaborative Annotation Panel Component
     *
     * Displays annotations with author information and real-time updates.
     */

    import React from 'react';
    import type { SharedAnnotation } from '../hooks/useSharedAnnotations';

    export interface CollaborativeAnnotationPanelProps {
      annotations: SharedAnnotation[];
      currentUserId?: string;
      onAddAnnotation?: (content: string, target?: string) => void;
      onUpdateAnnotation?: (id: string, updates: any) => void;
      onDeleteAnnotation?: (id: string) => void;
      onResolveAnnotation?: (id: string, status: 'open' | 'in-progress' | 'resolved') => void;
    }

    export function CollaborativeAnnotationPanel({
      annotations,
      currentUserId,
      onAddAnnotation,
      onUpdateAnnotation,
      onDeleteAnnotation,
      onResolveAnnotation,
    }: CollaborativeAnnotationPanelProps) {
      const [filter, setFilter] = React.useState<'all' | 'mine' | 'open'>('all');

      // Filter annotations
      const filteredAnnotations = React.useMemo(() => {
        switch (filter) {
          case 'mine':
            return annotations.filter((a) => a.authorId === currentUserId);
          case 'open':
            return annotations.filter((a) => a.status === 'open');
          default:
            return annotations;
        }
      }, [annotations, filter, currentUserId]);

      // Group by status
      const grouped = React.useMemo(() => ({
        open: filteredAnnotations.filter((a) => a.status === 'open'),
        inProgress: filteredAnnotations.filter((a) => a.status === 'in-progress'),
        resolved: filteredAnnotations.filter((a) => a.status === 'resolved'),
      }), [filteredAnnotations]);

      return (
        <div className="collaborative-annotation-panel">
          {/* Header with filter */}
          <div className="flex items-center justify-between mb-4">
            <h2 className="text-lg font-semibold text-gray-900 dark:text-white">
              Anotações ({annotations.length})
            </h2>
            <div className="flex items-center gap-2">
              <button
                onClick={() => setFilter('all')}
                className={`px-3 py-1 text-xs font-medium rounded-lg transition-colors ${
                  filter === 'all'
                    ? 'bg-blue-100 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400'
                    : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700'
                }`}
              >
                Todas
              </button>
              <button
                onClick={() => setFilter('mine')}
                className={`px-3 py-1 text-xs font-medium rounded-lg transition-colors ${
                  filter === 'mine'
                    ? 'bg-blue-100 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400'
                    : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700'
                }`}
              >
                Minhas
              </button>
              <button
                onClick={() => setFilter('open')}
                className={`px-3 py-1 text-xs font-medium rounded-lg transition-colors ${
                  filter === 'open'
                    ? 'bg-blue-100 dark:bg-blue-900/20 text-blue-700 dark:text-blue-400'
                    : 'text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700'
                }`}
              >
                Abertas
              </button>
            </div>
          </div>

          {/* Annotations by status */}
          <div className="space-y-6">
            <AnnotationGroup
              title="Abertas"
              annotations={grouped.open}
              currentUserId={currentUserId}
              onUpdate={onUpdateAnnotation}
              onDelete={onDeleteAnnotation}
              onResolve={onResolveAnnotation}
            />
            <AnnotationGroup
              title="Em Progresso"
              annotations={grouped.inProgress}
              currentUserId={currentUserId}
              onUpdate={onUpdateAnnotation}
              onDelete={onDeleteAnnotation}
              onResolve={onResolveAnnotation}
            />
            <AnnotationGroup
              title="Resolvidas"
              annotations={grouped.resolved}
              currentUserId={currentUserId}
              onUpdate={onUpdateAnnotation}
              onDelete={onDeleteAnnotation}
              onResolve={onResolveAnnotation}
            />
          </div>
        </div>
      );
    }

    interface AnnotationGroupProps {
      title: string;
      annotations: SharedAnnotation[];
      currentUserId?: string;
      onUpdate?: (id: string, updates: any) => void;
      onDelete?: (id: string) => void;
      onResolve?: (id: string, status: 'open' | 'in-progress' | 'resolved') => void;
    }

    function AnnotationGroup({
      title,
      annotations,
      currentUserId,
      onUpdate,
      onDelete,
      onResolve,
    }: AnnotationGroupProps) {
      if (annotations.length === 0) return null;

      return (
        <div>
          <h3 className="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wide mb-3">
            {title} ({annotations.length})
          </h3>
          <div className="space-y-3">
            {annotations.map((annotation) => (
              <CollaborativeAnnotationCard
                key={annotation.id}
                annotation={annotation}
                isOwner={annotation.authorId === currentUserId}
                onUpdate={onUpdate}
                onDelete={onDelete}
                onResolve={onResolve}
              />
            ))}
          </div>
        </div>
      );
    }

    interface CollaborativeAnnotationCardProps {
      annotation: SharedAnnotation;
      isOwner: boolean;
      onUpdate?: (id: string, updates: any) => void;
      onDelete?: (id: string) => void;
      onResolve?: (id: string, status: 'open' | 'in-progress' | 'resolved') => void;
    }

    function CollaborativeAnnotationCard({
      annotation,
      isOwner,
      onUpdate,
      onDelete,
      onResolve,
    }: CollaborativeAnnotationCardProps) {
      const statusColors = {
        open: 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/20 dark:text-yellow-300',
        'in-progress': 'bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-300',
        resolved: 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-300',
      };

      return (
        <div className="p-4 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700">
          <div className="flex items-start gap-3">
            {/* Author avatar */}
            <div
              className="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium flex-shrink-0"
              style={{ backgroundColor: annotation.authorColor || '#6366f1' }}
            >
              {annotation.authorName.charAt(0).toUpperCase()}
            </div>

            <div className="flex-1 min-w-0">
              {/* Header */}
              <div className="flex items-center justify-between mb-2">
                <span className="text-sm font-medium text-gray-900 dark:text-white">
                  {annotation.authorName}
                </span>
                <span className={`
                  px-2 py-0.5 text-xs font-medium rounded-full
                  ${statusColors[annotation.status || 'open']}
                `}>
                  {annotation.status === 'open' ? 'Aberta' : annotation.status === 'in-progress' ? 'Em Progresso' : 'Resolvida'}
                </span>
              </div>

              {/* Content */}
              {annotation.content && (
                <p className="text-sm text-gray-700 dark:text-gray-300 mb-2">
                  {annotation.content}
                </p>
              )}

              {/* Target reference */}
              {annotation.target && (
                <code className="text-xs bg-gray-100 dark:bg-gray-700 px-2 py-1 rounded text-gray-600 dark:text-gray-400">
                  {annotation.target}
                </code>
              )}

              {/* Timestamp */}
              <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                {new Date(annotation.createdAt).toLocaleString('pt-BR')}
              </p>
            </div>

            {/* Actions for owner */}
            {isOwner && (
              <div className="flex flex-col gap-1">
                {onResolve && annotation.status !== 'resolved' && (
                  <button
                    onClick={() => onResolve(annotation.id, 'resolved')}
                    className="text-xs text-green-600 dark:text-green-400 hover:underline"
                    title="Marcar como resolvida"
                  >
                    ✓
                  </button>
                )}
                {onDelete && (
                  <button
                    onClick={() => onDelete(annotation.id)}
                    className="text-xs text-red-600 dark:text-red-400 hover:underline"
                    title="Excluir"
                  >
                    ✕
                  </button>
                )}
              </div>
            )}
          </div>
        </div>
      );
    }

    export default CollaborativeAnnotationPanel;
    ```

    Save to `apps/portal/src/components/CollaborativeAnnotationPanel.tsx`.
  </action>
  <verify>CollaborativeAnnotationPanel component created</verify>
  <done>Collaborative annotation panel</done>
</task>

<task type="auto">
  <name>Integrate into SharedDocument page</name>
  <files>apps/portal/src/pages/SharedDocument.tsx</files>
  <action>
    Update `apps/portal/src/pages/SharedDocument.tsx` to use collaborative annotations:

    1. Import hooks and components:
    ```typescript
    import { useSharedAnnotations } from '../hooks/useSharedAnnotations';
    import { CollaborativeAnnotationPanel } from '../components/CollaborativeAnnotationPanel';
    import { getCurrentUser } from '@obsidian-note-reviewer/collaboration';
    ```

    2. Add shared annotations hook:
    ```typescript
    const user = getCurrentUser();
    const { annotations, addAnnotation, updateAnnotation, deleteAnnotation, resolveAnnotation } = useSharedAnnotations({
      documentId: documentId,
      roomId: `shared-${documentId}`,
    });
    ```

    3. Replace AnnotationExport with CollaborativeAnnotationPanel

    This enables multi-user annotation on shared documents.
  </action>
  <verify>SharedDocument uses collaborative annotations</verify>
  <done>Integrated collaborative annotations</done>
</task>

</tasks>

<verification>
- [ ] useSharedAnnotations hook with author tracking
- [ ] CollaborativeAnnotationPanel with author avatars
- [ ] Filter by all/mine/open
- [ ] Group by status (open/in-progress/resolved)
- [ ] Owner actions (resolve, delete)
- [ ] Real-time sync via Liveblocks
</verification>

<success_criteria>
1. Multiple users can annotate shared plans (SHAR-02)
2. Annotations show author information
3. Real-time sync between users
4. Author avatars and names visible
</success_criteria>

---

**Plan created:** 2026-02-06
**Estimated duration:** 25 min
**Complexity:** Medium (multi-user state, real-time sync, conflict resolution)

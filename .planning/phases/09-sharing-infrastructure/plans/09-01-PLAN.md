---
phase: 09-sharing-infrastructure
plan: 01
type: execute
wave: 1
depends_on: ["05-02"]
files_modified:
  - apps/portal/src/hooks/useSlugRouting.ts
  - apps/portal/src/components/SlugInput.tsx
  - apps/portal/src/pages/ShareDialog.tsx
  - apps/portal/src/pages/SharedDocument.tsx
autonomous: false

must_haves:
  truths:
    - "URLs use friendly slugs instead of UUIDs"
    - "Slugs are validated for uniqueness"
    - "Slug format is URL-safe (lowercase, hyphens)"
    - "Conflict detection when creating duplicate slugs"
    - "Slug generation from document title"
  artifacts:
    - path: "apps/portal/src/hooks/useSlugRouting.ts"
      provides: "Slug routing and validation hook"
      exports: ["useSlugRouting", "generateSlug", "validateSlug"]
      min_lines: 80
    - path: "apps/portal/src/components/SlugInput.tsx"
      provides: "Slug input component with validation"
      exports: ["SlugInput"]
      min_lines: 100

<objective>
Implement slug-based URL routing with validation for shared document links.

**Purpose:** Deliver SHAR-01 requirement - friendly slug-based URLs for shared reviews.

**Output:** Complete slug system with generation, validation, and routing.
</objective>

<tasks>

<task type="auto">
  <name>Create useSlugRouting hook</name>
  <files>apps/portal/src/hooks/useSlugRouting.ts</files>
  <action>
    Create `apps/portal/src/hooks/useSlugRouting.ts`:

    ```typescript
    /**
     * Slug Routing Hook
     *
     * Manages slug generation and validation for shared documents.
     */

    import { useState, useCallback } from 'react';

    export interface SlugValidation {
      isValid: boolean;
      isAvailable: boolean;
      error?: string;
    }

    export interface UseSlugRoutingOptions {
      existingSlugs?: string[];
      minLength?: number;
      maxLength?: number;
    }

    export interface UseSlugRoutingReturn {
      slug: string;
      setSlug: (slug: string) => void;
      generateSlug: (title: string) => string;
      validateSlug: (slug: string) => SlugValidation;
      generateUniqueSlug: (title: string) => string;
      slugToUrl: (slug: string, baseUrl?: string) => string;
    }

    const DEFAULT_OPTIONS = {
      minLength: 3,
      maxLength: 50,
    };

    /**
     * Convert title to URL-friendly slug
     */
    export function generateSlug(title: string): string {
      return title
        .toLowerCase()
        // Remove accents
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        // Replace spaces and special chars with hyphens
        .replace(/[^a-z0-9\s-]/g, '')
        .trim()
        .replace(/\s+/g, '-')
        .replace(/-+/g, '-')
        // Remove leading/trailing hyphens
        .replace(/^-+|-+$/g, '');
    }

    /**
     * Check if slug is valid format
     */
    function isValidSlugFormat(slug: string): boolean {
      // Only lowercase letters, numbers, hyphens
      return /^[a-z0-9-]+$/.test(slug) && slug.length > 0;
    }

    /**
     * Hook for slug routing management
     */
    export function useSlugRouting(options: UseSlugRoutingOptions = {}): UseSlugRoutingReturn {
      const { existingSlugs = [], minLength = 3, maxLength = 50 } = options;

      const [slug, setSlugState] = useState<string>('');

      /**
       * Set slug and validate
       */
      const setSlug = useCallback((newSlug: string) => {
        setSlugState(newSlug);
      }, []);

      /**
       * Validate slug
       */
      const validateSlug = useCallback((slugToCheck: string): SlugValidation => {
        // Check format
        if (!isValidSlugFormat(slugToCheck)) {
          return {
            isValid: false,
            isAvailable: false,
            error: 'Use apenas letras, números e hífens',
          };
        }

        // Check length
        if (slugToCheck.length < minLength) {
          return {
            isValid: false,
            isAvailable: false,
            error: `Mínimo de ${minLength} caracteres`,
          };
        }

        if (slugToCheck.length > maxLength) {
          return {
            isValid: false,
            isAvailable: false,
            error: `Máximo de ${maxLength} caracteres`,
          };
        }

        // Check availability
        const isAvailable = !existingSlugs.includes(slugToCheck);

        return {
          isValid: true,
          isAvailable,
          error: isAvailable ? undefined : 'Este nome já está em uso',
        };
      }, [existingSlugs, minLength, maxLength]);

      /**
       * Generate unique slug from title
       */
      const generateUniqueSlug = useCallback((title: string): string => {
        let baseSlug = generateSlug(title);
        let uniqueSlug = baseSlug;
        let counter = 1;

        // Find available slug
        while (existingSlugs.includes(uniqueSlug)) {
          uniqueSlug = `${baseSlug}-${counter}`;
          counter++;
        }

        return uniqueSlug;
      }, [existingSlugs]);

      /**
       * Convert slug to full URL
       */
      const slugToUrl = useCallback((slugValue: string, baseUrl = window.location.origin): string => {
        return `${baseUrl}/shared/${slugValue}`;
      }, []);

      return {
        slug,
        setSlug,
        generateSlug,
        validateSlug,
        generateUniqueSlug,
        slugToUrl,
      };
    }

    export default useSlugRouting;
    ```

    Save to `apps/portal/src/hooks/useSlugRouting.ts`.
  </action>
  <verify>useSlugRouting hook created</verify>
  <done>Slug routing hook</done>
</task>

<task type="auto">
  <name>Create SlugInput component</name>
  <files>apps/portal/src/components/SlugInput.tsx</files>
  <action>
    Create `apps/portal/src/components/SlugInput.tsx`:

    ```typescript
    /**
     * Slug Input Component
     *
     * Input field for entering document slug with validation.
     */

    import React, { useState, useEffect } from 'react';
    import { validateSlug, generateSlug } from '../hooks/useSlugRouting';

    export interface SlugInputProps {
      value: string;
      onChange: (slug: string) => void;
      title: string;
      existingSlugs?: string[];
      readOnly?: boolean;
      autoFocus?: boolean;
    }

    export function SlugInput({
      value,
      onChange,
      title,
      existingSlugs = [],
      readOnly = false,
      autoFocus = false,
    }: SlugInputProps) {
      const [validation, setValidation] = useState<{
        isValid: boolean;
        isAvailable: boolean;
        error?: string;
      }>({ isValid: true, isAvailable: true });

      const [touched, setTouched] = useState(false);

      // Validate when value changes
      useEffect(() => {
        if (!value) {
          setValidation({ isValid: true, isAvailable: true });
          return;
        }

        const result = validateSlug(value, existingSlugs);
        setValidation(result);
      }, [value, existingSlugs]);

      // Auto-generate from title on mount
      useEffect(() => {
        if (!value && title && !readOnly) {
          const generated = generateSlug(title);
          onChange(generated);
        }
      }, [title, value, onChange, readOnly]);

      const getStatusColor = () => {
        if (!value || !touched) return 'gray';
        if (!validation.isValid) return 'red';
        if (!validation.isAvailable) return 'orange';
        return 'green';
      };

      const statusColor = getStatusColor();

      return (
        <div className="slug-input">
          <div className="flex items-center gap-2 mb-2">
            <label className="text-sm font-medium text-gray-700 dark:text-gray-300">
              Link personalizado
            </label>
            {validation.error && touched && (
              <span className="text-xs text-red-600 dark:text-red-400">
                {validation.error}
              </span>
            )}
            {validation.isAvailable && value && touched && (
              <span className="text-xs text-green-600 dark:text-green-400 flex items-center gap-1">
                <svg className="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                  <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clipRule="evenodd" />
                </svg>
                Disponível
              </span>
            )}
          </div>

          <div className="flex items-center gap-2">
            <span className="text-gray-500 dark:text-gray-400 text-sm">
              r.alexdonega.com.br/shared/
            </span>
            <input
              type="text"
              value={value}
              onChange={(e) => onChange(e.target.value)}
              onFocus={() => setTouched(true)}
              readOnly={readOnly}
              autoFocus={autoFocus}
              placeholder={readOnly ? '' : 'gerado-automaticamente'}
              className={`
                flex-1 px-3 py-2 text-sm bg-gray-50 dark:bg-gray-900
                border border-gray-300 dark:border-gray-600 rounded-lg
                focus:ring-2 focus:ring-blue-500 focus:border-transparent
                ${readOnly ? 'cursor-not-allowed opacity-70' : ''}
                ${!validation.isValid && touched ? 'border-red-500' : ''}
                ${validation.isAvailable && value && touched ? 'border-green-500' : ''}
              `}
            />
          </div>

          {value && (
            <div className="mt-2 p-3 bg-gray-100 dark:bg-gray-800 rounded-lg">
              <p className="text-xs text-gray-600 dark:text-gray-400 mb-1">
                Link completo:
              </p>
              <code className="text-xs text-gray-900 dark:text-gray-100 break-all">
                r.alexdonega.com.br/shared/{value}
              </code>
            </div>
          )}
        </div>
      );
    }

    export default SlugInput;
    ```

    Save to `apps/portal/src/components/SlugInput.tsx`.
  </action>
  <verify>SlugInput component created</verify>
  <done>Slug input component</done>
</task>

<task type="auto">
  <name>Update ShareDialog with slug input</name>
  <files>apps/portal/src/components/ShareDialog.tsx</files>
  <action>
    Update `apps/portal/src/components/ShareDialog.tsx` to use SlugInput:

    1. Import SlugInput:
    ```typescript
    import { SlugInput } from './SlugInput';
    import { useSlugRouting } from '../hooks/useSlugRouting';
    ```

    2. Add slug state:
    ```typescript
    const { slug, setSlug, generateUniqueSlug, slugToUrl } = useSlugRouting({
      existingSlugs: existingSlugs || [],
    });

    // Generate slug from document title on mount
    useEffect(() => {
      if (documentTitle && !slug) {
        setSlug(generateUniqueSlug(documentTitle));
      }
    }, [documentTitle, slug]);
    ```

    3. Replace URL input with SlugInput component

    This integrates slug-based routing into the share dialog.
  </action>
  <verify>ShareDialog uses SlugInput</verify>
  <done>Updated share dialog</done>
</task>

</tasks>

<verification>
- [ ] useSlugRouting hook with slug generation
- [ ] Slug validation (format, length, uniqueness)
- [ ] SlugInput component with visual feedback
- [ ] Auto-generation from title
- [ ] Full URL preview
- [ ] ShareDialog integration
</verification>

<success_criteria>
1. Shared reviews use friendly slug-based URLs (SHAR-01)
2. Slugs are validated for uniqueness
3. Slug format is URL-safe
4. Conflict detection for duplicates
</success_criteria>

---

**Plan created:** 2026-02-06
**Estimated duration:** 20 min
**Complexity:** Medium (slug generation, validation, routing)

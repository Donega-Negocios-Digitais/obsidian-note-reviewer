# 10-04: Create Stripe Webhook Endpoints with Signature Verification

## Goal
Create secure Stripe webhook endpoints to handle payment events and update subscription status.

## Requirements
- MONY-05: Stripe webhooks are verified with signature validation for security

## Success Criteria
1. Webhook endpoint receives Stripe events
2. Signature verification prevents fake events
3. Successful payments upgrade users to Pro
4. Failed payments/downgrades handled
5. Cancellations revert users to Free tier

## Implementation Plan

### 1. Create Webhook Types
```typescript
// packages/collaboration/src/types/webhook.ts
export type StripeWebhookEvent =
  | 'checkout.session.completed'
  | 'customer.subscription.created'
  | 'customer.subscription.updated'
  | 'customer.subscription.deleted'
  | 'invoice.paid'
  | 'invoice.payment_failed';

export interface WebhookPayload {
  id: string;
  type: StripeWebhookEvent;
  data: {
    object: Record<string, unknown>;
  };
}
```

### 2. Create Signature Verification
```typescript
// apps/portal/src/utils/stripeWebhooks.ts
import crypto from 'crypto';

export function verifyStripeSignature(
  payload: string,
  signature: string,
  webhookSecret: string
): boolean {
  const hmac = crypto
    .createHmac('sha256', webhookSecret)
    .update(payload)
    .digest('hex');

  return crypto.timingSafeEqual(
    Buffer.from(signature.split('=')[1] || ''),
    Buffer.from(hmac)
  );
}
```

### 3. Create Webhook Handler
```typescript
// apps/portal/src/api/webhooks/stripe.ts
export async function handleStripeWebhook(event: WebhookPayload) {
  switch (event.type) {
    case 'checkout.session.completed':
      await handleCheckoutCompleted(event.data.object);
      break;
    case 'customer.subscription.created':
      await handleSubscriptionCreated(event.data.object);
      break;
    case 'customer.subscription.deleted':
      await handleSubscriptionDeleted(event.data.object);
      break;
    case 'invoice.payment_failed':
      await handlePaymentFailed(event.data.object);
      break;
  }
}
```

### 4. Create Subscription Update Functions
```typescript
// apps/portal/src/api/subscription.ts
export async function upgradeUserToPro(
  userId: string,
  stripeCustomerId: string,
  subscriptionType: SubscriptionType
) {
  // Update Supabase user_metadata
}

export async function downgradeUserToFree(userId: string) {
  // Update Supabase user_metadata
}
```

### 5. Create API Endpoint (Backend)
```typescript
// Server-side webhook endpoint
// POST /api/webhooks/stripe
// Verify signature
// Parse event
// Handle event
// Return 200 OK
```

## Files to Create
- `apps/portal/src/utils/stripeWebhooks.ts`
- `apps/portal/src/api/subscription.ts`
- Backend webhook endpoint

## Files to Modify
- Supabase user_metadata schema - Add subscription fields

## Environment Variables Required
```
STRIPE_WEBHOOK_SECRET=whsec_...
STRIPE_SECRET_KEY=sk_test_...
```

## Security Considerations
- Always verify signature before processing
- Use timing-safe comparison to prevent timing attacks
- Log all webhook events for debugging
- Return 200 OK even if processing fails (Stripe retries)

## Webhook Events to Handle
| Event | Action |
|-------|--------|
| checkout.session.completed | Create customer, upgrade to Pro |
| customer.subscription.created | Store subscription ID |
| customer.subscription.updated | Update subscription status |
| customer.subscription.deleted | Downgrade to Free |
| invoice.paid | Extend access (if needed) |
| invoice.payment_failed | Send warning email |

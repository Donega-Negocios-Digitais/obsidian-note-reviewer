---
phase: 05-configuration-system
plan: 02
type: execute
wave: 1
depends_on: ["08-01"]
files_modified:
  - apps/portal/src/hooks/useTheme.ts
  - apps/portal/src/hooks/useDarkMode.ts
  - apps/portal/src/components/ThemeProvider.tsx
  - apps/portal/src/pages/Settings.tsx
autonomous: false

must_haves:
  truths:
    - "Theme preference persists to localStorage"
    - "Automatic mode follows system preference"
    - "Manual override available (light/dark)"
    - "Smooth transitions between themes"
    - "All components respect theme setting"
  artifacts:
    - path: "apps/portal/src/hooks/useTheme.ts"
      provides: "Theme management hook"
      exports: ["useTheme"]
      min_lines: 80
    - path: "apps/portal/src/hooks/useDarkMode.ts"
      provides: "Dark mode detection and management"
      exports: ["useDarkMode"]
      min_lines: 60
    - path: "apps/portal/src/components/ThemeProvider.tsx"
      provides: "Theme provider for React tree"
      exports: ["ThemeProvider"]
      min_lines: 50

<objective>
Implement theme configuration with automatic dark/light mode switching.

**Purpose:** Deliver CONF-02 requirement - theme preference with automatic mode.

**Output:** Complete theme system with provider, hooks, and settings integration.
</objective>

<tasks>

<task type="auto">
  <name>Create useDarkMode hook</name>
  <files>apps/portal/src/hooks/useDarkMode.ts</files>
  <action>
    Create `apps/portal/src/hooks/useDarkMode.ts`:

    ```typescript
    /**
     * Dark Mode Hook
     *
     * Detects and manages dark mode preference.
     */

    import { useState, useEffect, useCallback } from 'react';

    export type ThemeMode = 'light' | 'dark' | 'system';

    export interface DarkModeState {
      mode: ThemeMode;
      isDark: boolean;
    }

    export interface UseDarkModeReturn {
      mode: ThemeMode;
      isDark: boolean;
      setMode: (mode: ThemeMode) => void;
      toggle: () => void;
    }

    const STORAGE_KEY = 'obsreview-theme-mode';
    const DEFAULT_MODE: ThemeMode = 'system';

    /**
     * Get system dark mode preference
     */
    function getSystemDarkMode(): boolean {
      if (typeof window === 'undefined') return false;
      return window.matchMedia('(prefers-color-scheme: dark)').matches;
    }

    /**
     * Get effective dark mode based on theme mode setting
     */
    function getEffectiveDarkMode(mode: ThemeMode): boolean {
      if (mode === 'system') {
        return getSystemDarkMode();
      }
      return mode === 'dark';
    }

    /**
     * Hook for managing dark mode
     */
    export function useDarkMode(): UseDarkModeReturn {
      const [mode, setModeState] = useState<ThemeMode>(() => {
        if (typeof window === 'undefined') return DEFAULT_MODE;

        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored && ['light', 'dark', 'system'].includes(stored)) {
            return stored as ThemeMode;
          }
        } catch (e) {
          console.warn('Could not read theme mode from localStorage:', e);
        }

        return DEFAULT_MODE;
      });

      const [isDark, setIsDark] = useState(() => getEffectiveDarkMode(mode));

      // Update dark mode when mode changes or system preference changes
      useEffect(() => {
        const updateDarkMode = () => {
          setIsDark(getEffectiveDarkMode(mode));
        };

        updateDarkMode();

        if (mode === 'system') {
          // Listen for system preference changes
          const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
          mediaQuery.addEventListener('change', updateDarkMode);
          return () => mediaQuery.removeEventListener('change', updateDarkMode);
        }
      }, [mode]);

      // Set mode and persist to localStorage
      const setMode = useCallback((newMode: ThemeMode) => {
        setModeState(newMode);
        setIsDark(getEffectiveDarkMode(newMode));

        try {
          localStorage.setItem(STORAGE_KEY, newMode);
        } catch (e) {
          console.warn('Could not save theme mode to localStorage:', e);
        }
      }, []);

      // Toggle between light and dark (ignores system)
      const toggle = useCallback(() => {
        setMode(mode === 'dark' ? 'light' : 'dark');
      }, [mode, setMode]);

      return {
        mode,
        isDark,
        setMode,
        toggle,
      };
    }

    export default useDarkMode;
    ```

    Save to `apps/portal/src/hooks/useDarkMode.ts`.
  </action>
  <verify>useDarkMode hook created</verify>
  <done>Dark mode hook</done>
</task>

<task type="auto">
  <name>Create ThemeProvider component</name>
  <files>apps/portal/src/components/ThemeProvider.tsx</files>
  <action>
    Create `apps/portal/src/components/ThemeProvider.tsx`:

    ```typescript
    /**
     * Theme Provider Component
     *
     * Provides theme context to React tree.
     */

    import React, { useEffect } from 'react';
    import { useDarkMode } from '../hooks/useDarkMode';

    export interface ThemeProviderProps {
      children: React.ReactNode;
    }

    const ThemeContext = React.createContext<{
      mode: 'light' | 'dark' | 'system';
      isDark: boolean;
      setMode: (mode: 'light' | 'dark' | 'system') => void;
      toggle: () => void;
    } | null>(null);

    /**
     * Theme provider component
     *
     * Wraps the app and provides theme context to all children.
     * Also applies dark mode class to document element.
     */
    export function ThemeProvider({ children }: ThemeProviderProps) {
      const { mode, isDark, setMode, toggle } = useDarkMode();

      // Apply dark mode class to document
      useEffect(() => {
        const root = document.documentElement;

        if (isDark) {
          root.classList.add('dark');
        } else {
          root.classList.remove('dark');
        }

        // Set color-scheme for native elements
        root.style.colorScheme = isDark ? 'dark' : 'light';
      }, [isDark]);

      const contextValue = React.useMemo(
        () => ({ mode, isDark, setMode, toggle }),
        [mode, isDark, setMode, toggle]
      );

      return (
        <ThemeContext.Provider value={contextValue}>
          {children}
        </ThemeContext.Provider>
      );
    }

    /**
     * Hook to access theme context
     */
    export function useTheme() {
      const context = React.useContext(ThemeContext);

      if (!context) {
        throw new Error('useTheme must be used within ThemeProvider');
      }

      return context;
    }

    export default ThemeProvider;
    ```

    Save to `apps/portal/src/components/ThemeProvider.tsx`.
  </action>
  <verify>ThemeProvider component created</verify>
  <done>Theme provider</done>
</task>

<task type="auto">
  <name>Create useTheme hook wrapper</name>
  <files>apps/portal/src/hooks/useTheme.ts</files>
  <action>
    Create `apps/portal/src/hooks/useTheme.ts`:

    ```typescript
    /**
     * Theme Hook
     *
     * Convenience hook for accessing theme context.
     */

    import { useTheme as useThemeContext } from '../components/ThemeProvider';

    // Re-export for easier importing
    export { useTheme as useThemeContext };

    /**
     * Hook for accessing theme state
     *
     * Provides theme mode, dark status, and control functions.
     */
    export function useTheme() {
      return useThemeContext();
    }

    export default useTheme;
    ```

    Save to `apps/portal/src/hooks/useTheme.ts`.
  </action>
  <verify>useTheme hook created</verify>
  <done>Theme hook</done>
</task>

<task type="auto">
  <name>Integrate theme settings into Settings page</name>
  <files>apps/portal/src/pages/Settings.tsx</files>
  <action>
    Update `apps/portal/src/pages/Settings.tsx` to integrate theme settings:

    1. Import useTheme hook:
    ```typescript
    import { useTheme } from '../hooks/useTheme';
    ```

    2. Update AppearanceSettings component:
    ```typescript
    function AppearanceSettings() {
      const { mode, isDark, setMode } = useTheme();

      return (
        <div>
          <h2 className="text-2xl font-semibold text-gray-900 dark:text-white mb-6">
            AparÃªncia
          </h2>

          <SettingsSection>
            <SettingsItem
              title="Tema"
              description="Escolha o tema da aplicaÃ§Ã£o"
              icon="ðŸŽ¨"
              action={
                <select
                  value={mode}
                  onChange={(e) => setMode(e.target.value as 'light' | 'dark' | 'system')}
                  className="px-3 py-2 bg-gray-100 dark:bg-gray-700 border-0 rounded-lg text-sm text-gray-900 dark:text-white"
                >
                  <option value="light">Claro</option>
                  <option value="dark">Escuro</option>
                  <option value="system">AutomÃ¡tico (Sistema)</option>
                </select>
              }
            />
            <SettingsToggle
              label="Modo escuro"
              description={mode === 'system' ? `Atualmente ${isDark ? 'escuro' : 'claro'} (seguindo sistema)` : undefined}
              checked={isDark}
              onChange={() => setMode(isDark ? 'light' : 'dark')}
              icon="ðŸŒ™"
            />
          </SettingsSection>
        </div>
      );
    }
    ```

    This connects the theme settings to the actual theme system.
  </action>
  <verify>Theme settings integrated</verify>
  <done>Integrated theme settings</done>
</task>

</tasks>

<verification>
- [ ] useDarkMode hook with system detection
- [ ] ThemeProvider applies dark class to document
- [ ] Theme mode persists to localStorage
- [ ] useTheme hook provides theme context
- [ ] Settings page shows current theme
- [ ] Theme changes apply immediately
- [ ] System mode follows OS preference
</verification>

<success_criteria>
1. Theme preference configurable (CONF-02)
2. Automatic mode follows system preference
3. Manual light/dark override available
4. Changes apply immediately
</success_criteria>

---

**Plan created:** 2026-02-06
**Estimated duration:** 20 min
**Complexity:** Medium (localStorage, matchMedia, context provider)

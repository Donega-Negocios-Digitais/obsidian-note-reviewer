---
phase: 05-configuration-system
plan: 03
type: execute
wave: 1
depends_on: ["08-01"]
files_modified:
  - apps/portal/src/hooks/useSaveLocation.ts
  - apps/portal/src/pages/Settings.tsx
autonomous: false

must_haves:
  truths:
    - "User can choose save location (vault/cloud/both)"
    - "Preference persists to localStorage"
    - "Save logic respects the preference"
    - "Clear indication of current setting"
  artifacts:
    - path: "apps/portal/src/hooks/useSaveLocation.ts"
      provides: "Save location preference management"
      exports: ["useSaveLocation"]
      min_lines: 60

<objective>
Create save location preference system for choosing between Obsidian vault, cloud, or both.

**Purpose:** Deliver CONF-03 requirement - save location preference configuration.

**Output:** Complete save location system with preference storage and settings integration.
</objective>

<tasks>

<task type="auto">
  <name>Create useSaveLocation hook</name>
  <files>apps/portal/src/hooks/useSaveLocation.ts</files>
  <action>
    Create `apps/portal/src/hooks/useSaveLocation.ts`:

    ```typescript
    /**
     * Save Location Hook
     *
     * Manages save location preference for annotations.
     */

    import { useState, useCallback, useEffect } from 'react';

    export type SaveLocation = 'vault' | 'cloud' | 'both';

    export interface SaveLocationOptions {
      vaultPath?: string;
      cloudEnabled?: boolean;
    }

    export interface UseSaveLocationReturn {
      location: SaveLocation;
      setLocation: (location: SaveLocation) => void;
      shouldSaveToVault: boolean;
      shouldSaveToCloud: boolean;
      vaultPath?: string;
      setVaultPath: (path: string) => void;
    }

    const STORAGE_KEY = 'obsreview-save-location';
    const VAULT_PATH_KEY = 'obsreview-vault-path';

    const DEFAULT_LOCATION: SaveLocation = 'vault';

    /**
     * Hook for managing save location preference
     */
    export function useSaveLocation(): UseSaveLocationReturn {
      const [location, setLocationState] = useState<SaveLocation>(() => {
        if (typeof window === 'undefined') return DEFAULT_LOCATION;

        try {
          const stored = localStorage.getItem(STORAGE_KEY);
          if (stored && ['vault', 'cloud', 'both'].includes(stored)) {
            return stored as SaveLocation;
          }
        } catch (e) {
          console.warn('Could not read save location from localStorage:', e);
        }

        return DEFAULT_LOCATION;
      });

      const [vaultPath, setVaultPathState] = useState<string>(() => {
        if (typeof window === 'undefined') return '';

        try {
          return localStorage.getItem(VAULT_PATH_KEY) || '';
        } catch (e) {
          console.warn('Could not read vault path from localStorage:', e);
          return '';
        }
      });

      /**
       * Set location and persist to localStorage
       */
      const setLocation = useCallback((newLocation: SaveLocation) => {
        setLocationState(newLocation);

        try {
          localStorage.setItem(STORAGE_KEY, newLocation);
        } catch (e) {
          console.warn('Could not save location to localStorage:', e);
        }
      }, []);

      /**
       * Set vault path and persist
       */
      const setVaultPath = useCallback((path: string) => {
        setVaultPathState(path);

        try {
          localStorage.setItem(VAULT_PATH_KEY, path);
        } catch (e) {
          console.warn('Could not save vault path to localStorage:', e);
        }
      }, []);

      /**
       * Determine if should save to vault
       */
      const shouldSaveToVault = location === 'vault' || location === 'both';

      /**
       * Determine if should save to cloud
       */
      const shouldSaveToCloud = location === 'cloud' || location === 'both';

      return {
        location,
        setLocation,
        shouldSaveToVault,
        shouldSaveToCloud,
        vaultPath,
        setVaultPath,
      };
    }

    /**
     * Save annotations based on location preference
     */
    export async function saveAnnotations(
      location: SaveLocation,
      vaultPath: string,
      annotations: any[],
      cloudSave?: (annotations: any[]) => Promise<void>,
      vaultSave?: (path: string, annotations: any[]) => Promise<void>
    ): Promise<{ vault: boolean; cloud: boolean }> {
      const result = { vault: false, cloud: false };

      const shouldSaveToVault = location === 'vault' || location === 'both';
      const shouldSaveToCloud = location === 'cloud' || location === 'both';

      if (shouldSaveToVault && vaultSave && vaultPath) {
        try {
          await vaultSave(vaultPath, annotations);
          result.vault = true;
        } catch (e) {
          console.error('Failed to save to vault:', e);
        }
      }

      if (shouldSaveToCloud && cloudSave) {
        try {
          await cloudSave(annotations);
          result.cloud = true;
        } catch (e) {
          console.error('Failed to save to cloud:', e);
        }
      }

      return result;
    }

    export default useSaveLocation;
    ```

    Save to `apps/portal/src/hooks/useSaveLocation.ts`.
  </action>
  <verify>useSaveLocation hook created</verify>
  <done>Save location hook</done>
</task>

<task type="auto">
  <name>Integrate save location into Settings</name>
  <files>apps/portal/src/pages/Settings.tsx</files>
  <action>
    Update `apps/portal/src/pages/Settings.tsx` to integrate save location settings:

    1. Import useSaveLocation hook:
    ```typescript
    import { useSaveLocation } from '../hooks/useSaveLocation';
    import { SettingsSelect, SettingsItem, SettingsSection } from '../components/SettingsItem';
    ```

    2. Update AnnotationsSettings component:
    ```typescript
    function AnnotationsSettings() {
      const { location, setLocation, vaultPath, setVaultPath } = useSaveLocation();

      const SAVE_LOCATION_OPTIONS = [
        { value: 'vault', label: 'Vault do Obsidian' },
        { value: 'cloud', label: 'Nuvem (Supabase)' },
        { value: 'both', label: 'Ambos' },
      ] as const;

      return (
        <div>
          <h2 className="text-2xl font-semibold text-gray-900 dark:text-white mb-6">
            Anota√ß√µes
          </h2>

          <SettingsSection>
            <SettingsToggle
              label="Auto-save"
              description="Salvar anota√ß√µes automaticamente enquanto voc√™ edits"
              checked={true}
              onChange={() => {}}
              icon="üíæ"
            />
          </SettingsSection>

          <SettingsSection title="Local de salvamento">
            <SettingsSelect
              label="Salvar em"
              description="Escolha onde suas anota√ß√µes s√£o salvas"
              value={location}
              options={SAVE_LOCATION_OPTIONS}
              onChange={setLocation}
              icon="üìÅ"
            />

            {(location === 'vault' || location === 'both') && (
              <SettingsItem
                title="Caminho do Vault"
                description="Localiza√ß√£o do vault do Obsidian"
                icon="üìÇ"
                action={
                  <button
                    onClick={() => {
                      // Trigger vault path selector
                      const path = prompt('Caminho do vault:', vaultPath);
                      if (path) setVaultPath(path);
                    }}
                    className="text-sm text-blue-600 dark:text-blue-400 font-medium"
                  >
                    {vaultPath || 'Selecionar...'}
                  </button>
                }
              />
            )}
          </SettingsSection>

          <SettingsSection title="Status">
            <SettingsItem
              title="√öltimo salvamento"
              description={location === 'vault'
                ? vaultPath
                  ? `Salvo localmente em ${vaultPath}`
                  : 'Configure o caminho do vault'
                : 'Salvo na nuvem'
              }
              icon="‚úì"
            />
          </SettingsSection>
        </div>
      );
    }
    ```

    This integrates save location preferences into settings.
  </action>
  <verify>Save location settings integrated</verify>
  <done>Integrated save location settings</done>
</task>

</tasks>

<verification>
- [ ] useSaveLocation hook manages preference
- [ ] Preference persists to localStorage
- [ ] Vault path configurable
- [ ] Settings page shows current location
- [ ] Clear indication of what each option does
- [ ] Helper function for saving based on preference
</verification>

<success_criteria>
1. Save location preference configurable (CONF-03)
2. Choose between vault/cloud/both
3. Preference persists across sessions
4. Save logic respects the setting
</success_criteria>

---

**Plan created:** 2026-02-06
**Estimated duration:** 15 min
**Complexity:** Low (localStorage, simple state, settings integration)

---
phase: 06-multi-document-review
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/portal/src/components/DocumentTabs.tsx
  - apps/portal/src/components/DocumentWorkspace.tsx
  - apps/portal/src/hooks/useDocumentTabs.ts
autonomous: false

must_haves:
  truths:
    - "Users can open multiple documents in tabs"
    - "Tabs show document title with close button"
    - "Active tab is visually highlighted"
    - "Tabs can be reordered (drag and drop)"
    - "New tab button for opening additional documents"
  artifacts:
    - path: "apps/portal/src/components/DocumentTabs.tsx"
      provides: "Tab bar component with drag reordering"
      min_lines: 150
    - path: "apps/portal/src/components/DocumentWorkspace.tsx"
      provides: "Workspace container with tabs and content"
      min_lines: 100
    - path: "apps/portal/src/hooks/useDocumentTabs.ts"
      provides: "Tab state management hook"
      min_lines: 80

<objective>
Build tabbed interface for viewing multiple documents simultaneously with drag reordering and state persistence.

**Purpose:** Deliver MULT-01 requirement - users can review multiple documents simultaneously.

**Output:** Complete tabbed workspace with multi-document support.
</objective>

<tasks>

<task type="auto">
  <name>Create useDocumentTabs hook</name>
  <files>apps/portal/src/hooks/useDocumentTabs.ts</files>
  <action>
    Create `apps/portal/src/hooks/useDocumentTabs.ts`:

    ```typescript
    /**
     * Document Tabs Hook
     *
     * Manages state for multiple open document tabs.
     */

    import { useState, useCallback } from 'react';

    export interface DocumentTab {
      id: string;
      documentId: string;
      title: string;
      content: string;
      modified: boolean;
      position: number;
    }

    export interface UseDocumentTabsOptions {
      maxTabs?: number;
      persistKey?: string;
    }

    export function useDocumentTabs(options: UseDocumentTabsOptions = {}) {
      const { maxTabs = 10, persistKey = 'obsreview-doc-tabs' } = options;

      const [tabs, setTabs] = useState<DocumentTab[]>([]);
      const [activeTabId, setActiveTabId] = useState<string | null>(null);

      const addTab = useCallback((document: Omit<DocumentTab, 'id' | 'position'>) => {
        setTabs((prev) => {
          // Check if already open
          const existing = prev.find((t) => t.documentId === document.documentId);
          if (existing) {
            setActiveTabId(existing.id);
            return prev;
          }

          // Check max tabs
          if (prev.length >= maxTabs) {
            return prev;
          }

          const newTab: DocumentTab = {
            ...document,
            id: `tab-${Date.now()}-${Math.random().toString(36).slice(2, 8)}`,
            position: prev.length,
          };

          const updated = [...prev, newTab];
          setActiveTabId(newTab.id);

          // Persist to localStorage
          if (persistKey) {
            localStorage.setItem(persistKey, JSON.stringify(updated.map(t => ({
            documentId: t.documentId,
            title: t.title,
            position: t.position,
          }))));
          }

          return updated;
        });
      }, [maxTabs, persistKey]);

      const closeTab = useCallback((tabId: string) => {
        setTabs((prev) => {
          const updated = prev.filter((t) => t.id !== tabId);

          // Update active tab if closing active
          if (activeTabId === tabId) {
            const index = prev.findIndex((t) => t.id === tabId);
            const nextTab = updated[index] || updated[index - 1] || null;
            setActiveTabId(nextTab?.id || null);
          }

          if (persistKey && updated.length === 0) {
            localStorage.removeItem(persistKey);
          }

          return updated;
        });
      }, [activeTabId, persistKey]);

      const setActiveTab = useCallback((tabId: string) => {
        setActiveTabId(tabId);
      }, []);

      const moveTab = useCallback((tabId: string, newPosition: number) => {
        setTabs((prev) => {
          const tab = prev.find((t) => t.id === tabId);
          if (!tab) return prev;

          const withoutTab = prev.filter((t) => t.id !== tabId);
          const updated = [
            ...withoutTab.slice(0, newPosition),
            { ...tab, position: newPosition },
            ...withoutTab.slice(newPosition),
          ].map((t, i) => ({ ...t, position: i }));

          return updated;
        });
      }, []);

      const activeTab = tabs.find((t) => t.id === activeTabId) || null;

      return {
        tabs,
        activeTab,
        activeTabId,
        addTab,
        closeTab,
        setActiveTab,
        moveTab,
      };
    }
    ```

    Save to `apps/portal/src/hooks/useDocumentTabs.ts`.
  </action>
  <verify>useDocumentTabs hook exported</verify>
  <done>Document tabs hook</done>
</task>

<task type="auto">
  <name>Create DocumentTabs component</name>
  <files>apps/portal/src/components/DocumentTabs.tsx</files>
  <action>
    Create `apps/portal/src/components/DocumentTabs.tsx`:

    ```typescript
    /**
     * Document Tabs Component
     *
     * Tab bar for multiple open documents with drag reordering.
     */

    import React, { useRef } from 'react';
    import type { DocumentTab } from '../hooks/useDocumentTabs';

    export interface DocumentTabsProps {
      tabs: DocumentTab[];
      activeTabId: string | null;
      onTabClick: (tabId: string) => void;
      onTabClose: (tabId: string) => void;
      onTabMove?: (tabId: string, newPosition: number) => void;
    }

    export function DocumentTabs({
      tabs,
      activeTabId,
      onTabClick,
      onTabClose,
      onTabMove,
    }: DocumentTabsProps) {
      const dragSourceId = useRef<string | null>(null);

      const handleDragStart = (e: React.DragEvent, tabId: string) => {
        dragSourceId.current = tabId;
        e.dataTransfer.effectAllowed = 'move';
      };

      const handleDragOver = (e: React.DragEvent) => {
        e.preventDefault();
        e.dataTransfer.dropEffect = 'move';
      };

      const handleDrop = (e: React.DragEvent, targetTabId: string) => {
        e.preventDefault();
        if (!dragSourceId.current || !onTabMove) return;

        const sourceIndex = tabs.findIndex((t) => t.id === dragSourceId.current);
        const targetIndex = tabs.findIndex((t) => t.id === targetTabId);

        if (sourceIndex !== targetIndex && sourceIndex !== -1 && targetIndex !== -1) {
          onTabMove(dragSourceId.current, targetIndex);
        }

        dragSourceId.current = null;
      };

      return (
        <div className="document-tabs flex items-center gap-1 px-2 py-1 bg-gray-100 dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700 overflow-x-auto">
          {tabs.map((tab) => (
            <Tab
              key={tab.id}
              tab={tab}
              isActive={tab.id === activeTabId}
              onClick={() => onTabClick(tab.id)}
              onClose={() => onTabClose(tab.id)}
              onDragStart={(e) => handleDragStart(e, tab.id)}
              onDragOver={handleDragOver}
              onDrop={(e) => handleDrop(e, tab.id)}
            />
          ))}

          <button
            className="flex items-center justify-center w-8 h-8 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 rounded transition-colors"
            title="Nova aba"
          >
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
          </button>
        </div>
      );
    }

    interface TabProps {
      tab: DocumentTab;
      isActive: boolean;
      onClick: () => void;
      onClose: () => void;
      onDragStart: (e: React.DragEvent) => void;
      onDragOver: (e: React.DragEvent) => void;
      onDrop: (e: React.DragEvent) => void;
    }

    function Tab({ tab, isActive, onClick, onClose, onDragStart, onDragOver, onDrop }: TabProps) {
      return (
        <div
          draggable
          onDragStart={onDragStart}
          onDragOver={onDragOver}
          onDrop={onDrop}
          onClick={onClick}
          className={\`
            group flex items-center gap-2 px-3 py-2 rounded-t-lg border-b-2 cursor-pointer transition-colors min-w-0 max-w-[200px]
            \${
              isActive
                ? 'bg-white dark:bg-gray-900 border-blue-600 text-gray-900 dark:text-white'
                : 'bg-transparent border-transparent text-gray-600 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700'
            }
          \$}
        >
          <span className="flex-1 truncate text-sm font-medium">
            {tab.title}
          </span>

          {tab.modified && (
            <span className="w-2 h-2 rounded-full bg-blue-600 flex-shrink-0" />
          )}

          <button
            onClick={(e) => {
              e.stopPropagation();
              onClose();
            }}
            className="opacity-0 group-hover:opacity-100 p-0.5 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 rounded transition-all"
          >
            <svg className="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      );
    }

    export default DocumentTabs;
    ```

    Save to `apps/portal/src/components/DocumentTabs.tsx`.
  </action>
  <verify>DocumentTabs renders tabs with drag support</verify>
  <done>Document tabs component</done>
</task>

<task type="auto">
  <name>Create DocumentWorkspace component</name>
  <files>apps/portal/src/components/DocumentWorkspace.tsx</files>
  <action>
    Create `apps/portal/src/components/DocumentWorkspace.tsx`:

    ```typescript
    /**
     * Document Workspace Component
     *
     * Main workspace with tabs and document content.
     */

    import React from 'react';
    import { DocumentTabs } from './DocumentTabs';
    import { useDocumentTabs } from '../hooks/useDocumentTabs';
    import { MarkdownRenderer } from '@obsidian-note-reviewer/ui/markdown';
    import type { Document } from '../types/document';

    export interface DocumentWorkspaceProps {
      initialDocuments?: Document[];
      onDocumentChange?: (document: Document) => void;
    }

    export function DocumentWorkspace({
      initialDocuments = [],
      onDocumentChange,
    }: DocumentWorkspaceProps) {
      const {
        tabs,
        activeTab,
        activeTabId,
        addTab,
        closeTab,
        setActiveTab,
        moveTab,
      } = useDocumentTabs();

      // Open initial documents
      React.useEffect(() => {
        initialDocuments.forEach((doc) => {
          addTab({
            documentId: doc.id,
            title: doc.title,
            content: doc.content,
            modified: false,
          });
        });
      }, [initialDocuments, addTab]);

      const handleOpenDocument = (document: Document) => {
        addTab({
          documentId: document.id,
          title: document.title,
          content: document.content,
          modified: false,
        });
      };

      return (
        <div className="document-workspace flex flex-col h-full">
          {/* Tabs */}
          <DocumentTabs
            tabs={tabs}
            activeTabId={activeTabId}
            onTabClick={setActiveTab}
            onTabClose={closeTab}
            onTabMove={moveTab}
          />

          {/* Content */}
          <div className="flex-1 overflow-auto">
            {activeTab ? (
              <div className="p-6">
                <h1 className="text-2xl font-bold text-gray-900 dark:text-white mb-6">
                  {activeTab.title}
                </h1>
                <MarkdownRenderer content={activeTab.content} />
              </div>
            ) : (
              <div className="h-full flex items-center justify-center">
                <div className="text-center text-gray-500 dark:text-gray-400">
                  <svg className="w-16 h-16 mx-auto mb-4 text-gray-300 dark:text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={1.5} d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <p className="text-lg font-medium mb-2">Nenhum documento aberto</p>
                  <p className="text-sm">Selecione um documento para come√ßar</p>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    export default DocumentWorkspace;
    ```

    Save to `apps/portal/src/components/DocumentWorkspace.tsx`.
  </action>
  <verify>DocumentWorkspace renders tabs and content</verify>
  <done>Document workspace component</done>
</task>

</tasks>

<verification>
- [ ] useDocumentTabs hook manages tab state
- [ ] addTab creates new tab with unique ID
- [ ] closeTab removes tab and updates active
- [ ] moveTab reorders tabs
- [ ] DocumentTabs shows all tabs with active state
- [ ] Drag and drop reordering works
- [ ] DocumentWorkspace displays active tab content
</verification>

<success_criteria>
1. Users can open multiple documents in tabs (MULT-01)
2. Tabs show document titles
3. Active tab is visually highlighted
4. Tabs can be reordered via drag
</success_criteria>

---

**Plan created:** 2026-02-06
**Estimated duration:** 25 min
**Complexity:** Medium (tab state management, drag and drop)

# 13-02: Implement Robust Error Handling

## Goal
Implement comprehensive error handling with user-friendly error messages.

## Requirements
- QUAL-03: Errors are handled gracefully with user-friendly error messages

## Success Criteria
1. All async operations have try/catch blocks
2. Error messages are in Portuguese and user-friendly
3. Error boundaries catch React errors
4. API errors are properly handled and displayed
5. Network errors have retry options
6. Loading states prevent duplicate errors

## Implementation

### Error Types
```typescript
// packages/core/src/errors/types.ts
export class AppError extends Error {
  constructor(
    message: string,
    public code: string,
    public statusCode: number = 500,
    public retryable: boolean = false
  ) {
    super(message);
    this.name = 'AppError';
  }
}

export class NetworkError extends AppError {
  constructor(message: string) {
    super(message, 'NETWORK_ERROR', 0, true);
    this.name = 'NetworkError';
  }
}

export class ValidationError extends AppError {
  constructor(message: string, public field?: string) {
    super(message, 'VALIDATION_ERROR', 400);
    this.name = 'ValidationError';
  }
}

export class AuthError extends AppError {
  constructor(message: string) {
    super(message, 'AUTH_ERROR', 401);
    this.name = 'AuthError';
  }
}

export class NotFoundError extends AppError {
  constructor(resource: string) {
    super(`${resource} não encontrado`, 'NOT_FOUND', 404);
    this.name = 'NotFoundError';
  }
}
```

### Error Messages (Portuguese)
```typescript
// packages/core/src/errors/messages.ts
export const ERROR_MESSAGES = {
  // Network errors
  network: {
    default: 'Erro de conexão. Verifique sua internet.',
    timeout: 'A operação demorou muito. Tente novamente.',
    offline: 'Você está offline. Verifique sua conexão.',
  },

  // Auth errors
  auth: {
    unauthorized: 'Você não tem permissão para acessar este recurso.',
    sessionExpired: 'Sua sessão expirou. Faça login novamente.',
    invalidCredentials: 'Email ou senha incorretos.',
  },

  // Validation errors
  validation: {
    required: 'Este campo é obrigatório.',
    email: 'Email inválido.',
    minLength: 'Muito curto. Mínimo de {min} caracteres.',
    maxLength: 'Muito longo. Máximo de {max} caracteres.',
    invalidFormat: 'Formato inválido.',
  },

  // Generic errors
  generic: {
    default: 'Ocorreu um erro inesperado.',
    tryAgain: 'Tente novamente.',
    contactSupport: 'Se o problema continuar, entre em contato com o suporte.',
  },
};
```

### Error Boundary
```typescript
// packages/ui/src/components/ErrorBoundary.tsx
interface State {
  hasError: boolean;
  error: Error | null;
}

export class ErrorBoundary extends React.Component<
  { children: React.ReactNode; fallback?: React.ComponentType<{ error: Error }> },
  State
> {
  constructor(props: any) {
    super(props);
    this.state = { hasError: false, error: null };
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    log.error({
      error: error.message,
      stack: error.stack,
      componentStack: errorInfo.componentStack,
    }, 'React error boundary caught an error');
  }

  render() {
    if (this.state.hasError) {
      const Fallback = this.props.fallback || DefaultErrorFallback;
      return <Fallback error={this.state.error!} />;
    }
    return this.props.children;
  }
}
```

### API Error Handler
```typescript
// packages/core/src/api/handleError.ts
export function handleApiError(error: unknown): AppError {
  if (error instanceof AppError) {
    return error;
  }

  if (error instanceof Error) {
    // Check for network errors
    if (error.message.includes('fetch')) {
      return new NetworkError(ERROR_MESSAGES.network.default);
    }

    // Check for timeout
    if (error.message.includes('timeout')) {
      return new NetworkError(ERROR_MESSAGES.network.timeout);
    }

    return new AppError(error.message, 'UNKNOWN_ERROR');
  }

  return new AppError(ERROR_MESSAGES.generic.default, 'UNKNOWN_ERROR');
}
```

### Error Display Component
```typescript
// packages/ui/src/components/ErrorDisplay.tsx
interface ErrorDisplayProps {
  error: AppError;
  onRetry?: () => void;
  onDismiss?: () => void;
}

export function ErrorDisplay({ error, onRetry, onDismiss }: ErrorDisplayProps) {
  const getErrorMessage = (error: AppError): string => {
    // Return user-friendly Portuguese message
    return error.message;
  };

  return (
    <div className="p-4 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-xl">
      <div className="flex items-start gap-3">
        <svg className="w-5 h-5 text-red-600 dark:text-red-400 flex-shrink-0 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
          <path fillRule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clipRule="evenodd" />
        </svg>
        <div className="flex-1">
          <h4 className="text-sm font-medium text-red-900 dark:text-red-300">
            Erro
          </h4>
          <p className="text-sm text-red-700 dark:text-red-400 mt-1">
            {getErrorMessage(error)}
          </p>
          {error.retryable && onRetry && (
            <button
              onClick={onRetry}
              className="mt-3 px-3 py-1.5 text-sm font-medium text-red-700 dark:text-red-300 bg-red-100 dark:bg-red-900/30 rounded-lg hover:bg-red-200 dark:hover:bg-red-900/50 transition-colors"
            >
              Tentar Novamente
            </button>
          )}
        </div>
        {onDismiss && (
          <button
            onClick={onDismiss}
            className="text-red-400 hover:text-red-600 dark:hover:text-red-300 transition-colors"
          >
            <svg className="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        )}
      </div>
    </div>
  );
}
```

### Async Handler Wrapper
```typescript
// packages/core/src/utils/asyncHandler.ts
export function asyncHandler<T>(
  fn: () => Promise<T>,
  onError?: (error: AppError) => void
): Promise<T> {
  return fn().catch((error) => {
    const appError = handleApiError(error);
    if (onError) {
      onError(appError);
    } else {
      log.error({ error: appError }, 'Async error');
    }
    throw appError;
  });
}
```

## Files to Create
- `packages/core/src/errors/types.ts` - Error classes
- `packages/core/src/errors/messages.ts` - Error messages (Portuguese)
- `packages/ui/src/components/ErrorBoundary.tsx` - React error boundary
- `packages/ui/src/components/ErrorDisplay.tsx` - Error display component
- `packages/core/src/api/handleError.ts` - Error handler utility

## Files to Modify
- All API calls to wrap with error handling
- All async components to use ErrorBoundary

## Integration Points

### Supabase Errors
```typescript
import { PostgrestError } from '@supabase/supabase-js';

function handleSupabaseError(error: PostgrestError): AppError {
  if (error.code === 'PGRST116') {
    return new NotFoundError('Recurso');
  }
  // ... more error codes
}
```

### React Query Errors
```typescript
const { error } = useQuery({
  queryKey: ['document', id],
  queryFn: fetchDocument,
  onError: (error) => {
    const appError = handleApiError(error);
    setError(appError);
  },
});
```

## Testing Checklist
- [ ] All API calls have error handling
- [ ] Error messages are in Portuguese
- [ ] Error boundary wraps entire app
- [ ] Network errors show retry button
- [ ] Validation errors show field-level feedback
- [ ] Auth errors redirect to login
- [ ] 404 errors show not found page

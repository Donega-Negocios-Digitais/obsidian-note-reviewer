---
phase: 04-real-time-collaboration
plan: 03
type: execute
wave: 3
depends_on: ["04-01"]
files_modified:
  - apps/portal/src/pages/SharedDocument.tsx
  - apps/portal/src/components/GuestBanner.tsx
  - apps/portal/src/App.tsx
autonomous: false

must_haves:
  truths:
    - "Guest users can view shared documents without login"
    - "Guest users see banner encouraging them to sign up"
    - "Document content is visible to guests"
    - "Guests can see presence and cursors of other users"
    - "Route /shared/:slug is public (no auth required)"
  artifacts:
    - path: "apps/portal/src/pages/SharedDocument.tsx"
      provides: "Guest-accessible shared document page"
      min_lines: 150
    - path: "apps/portal/src/components/GuestBanner.tsx"
      provides: "Banner encouraging guests to sign up"
      min_lines: 50
    - path: "apps/portal/src/App.tsx"
      provides: "Public route for shared documents"
      min_lines: 0
  key_links:
    - from: "apps/portal/src/pages/SharedDocument.tsx"
      to: "apps/portal/src/components/collaboration/PresenceList.tsx"
      via: "import"
      pattern: "PresenceList"
    - from: "apps/portal/src/pages/SharedDocument.tsx"
      to: "apps/portal/src/components/collaboration/LiveCursors.tsx"
      via: "import"
      pattern: "LiveCursors"

---

<objective>
Implement guest access for viewing shared reviews without authentication requirement, with signup banner and full collaboration features (presence, cursors).

**Purpose:** Deliver COLL-04 requirement - guest users can view shared reviews without login.

**Output:** Complete guest access flow with shared document page.
</objective>

<execution_context>
@C:\Users\Alex\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Alex\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/phases/04-real-time-collaboration/04-CONTEXT.md
@.planning/phases/04-real-time-collaboration/04-RESEARCH.md

User locked decisions (from CONTEXT.md):
- **Permissoes de visualizacao**: Visualizacao completa (veem anotacoes, autores, cursores)
- **Criacao de anotacoes**: Convidados podem criar anotacoes persistentes (salvas como 'guest')
- **Indicador de modo guest**: Indicador sutil no topo (icone de usuario + "Convidado")
- **Presenca de convidados**: Presenca completa (convidados veem cursores e lista de usuarios, e vice-versa)

Research recommendations:
- Use Supabase RLS with 'anon' role for guest access
- Public route without auth requirement
- Share link format: /shared/{slug}

Existing from 04-01:
- PresenceList component (shows active users)
- CollaborationRoom for Liveblocks rooms
</context>

<tasks>

<task type="auto">
  <name>Create GuestBanner component</name>
  <files>apps/portal/src/components/GuestBanner.tsx</files>
  <action>
    Create apps/portal/src/components/GuestBanner.tsx:

    ```typescript
    /**
     * Guest Banner Component
     *
     * Banner shown to guest users encouraging them to sign up.
     * Per CONTEXT.md: "Indicador de modo guest: Indicador sutil no topo (icone de usuario + 'Convidado')"
     */

    import { useNavigate } from "react-router-dom";

    export function GuestBanner() {
      const navigate = useNavigate();

      return (
        <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white px-4 py-3">
          <div className="flex items-center justify-between gap-4 max-w-7xl mx-auto">
            <div className="flex items-center gap-3">
              {/* Guest icon */}
              <svg className="w-5 h-5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
              </svg>

              <div>
                <p className="font-medium text-sm">Visualizando como Convidado</p>
                <p className="text-xs text-blue-100">
                  Crie uma conta gratuita para anotar, comentar e colaborar
                </p>
              </div>
            </div>

            <button
              onClick={() => navigate("/auth/signup")}
              className="px-4 py-2 bg-white text-blue-600 font-medium rounded-lg hover:bg-blue-50 transition-colors whitespace-nowrap text-sm"
            >
              Criar Conta Grátis
            </button>
          </div>
        </div>
      );
    }

    export default GuestBanner;
    ```
  </action>
  <verify>GuestBanner.tsx shows signup CTA with guest indicator</verify>
  <done>Guest banner component with locked decision implemented</done>
</task>

<task type="auto">
  <name>Create SharedDocument page with guest support</name>
  <files>apps/portal/src/pages/SharedDocument.tsx</files>
  <action>
    Create apps/portal/src/pages/SharedDocument.tsx:

    ```typescript
    /**
     * Shared Document Page
     *
     * Guest-accessible page for viewing shared documents.
     * Per CONTEXT.md: "Visualizacao completa (veem anotacoes, autores, cursores)"
     * Per CONTEXT.md: "Presenca de convidados: Presenca completa (convidados veem cursores e lista de usuarios, e vice-versa)"
     */

    import { useState, useEffect } from "react";
    import { useParams, useNavigate } from "react-router-dom";
    import { GuestBanner } from "../components/GuestBanner";
    import { CollaborationRoom } from "../components/collaboration/RoomProvider";
    import { PresenceList } from "../components/collaboration/PresenceList";
    import { LiveCursors } from "../components/collaboration/LiveCursors";
    {/*
    TODO: Import DocumentViewer when integrating with existing viewer:
    import { DocumentViewer } from "../components/DocumentViewer";
    */}

    interface SharedDocumentData {
      id: string;
      title: string;
      content: string;
      annotations: unknown[];
      createdAt: string;
    }

    export function SharedDocument() {
      const { slug } = useParams<{ slug: string }>();
      const navigate = useNavigate();
      const [document, setDocument] = useState<SharedDocumentData | null>(null);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState<string | null>(null);

      // Guest users are always in guest mode
      const isGuest = true;

      useEffect(() => {
        if (!slug) {
          setError("Link inválido");
          setLoading(false);
          return;
        }

        // TODO: Fetch document by slug from Supabase API
        // For now, use mock data
        const fetchDocument = async () => {
          try {
            setLoading(true);

            // Mock response - replace with actual API call
            // const { data, error } = await supabase
            //   .from('shared_documents')
            //   .select('*')
            //   .eq('slug', slug)
            //   .eq('is_public', true)
            //   .single();

            setDocument({
              id: "mock-doc",
              title: "Documento Compartilhado",
              content: "# Conteúdo do Documento\n\nEste é um exemplo de documento compartilhado.",
              annotations: [],
              createdAt: new Date().toISOString(),
            });
          } catch (err) {
            setError("Documento não encontrado ou link expirou");
            console.error("Failed to fetch shared document:", err);
          } finally {
            setLoading(false);
          }
        };

        fetchDocument();
      }, [slug]);

      if (loading) {
        return (
          <div className="min-h-screen flex items-center justify-center bg-gray-50 dark:bg-gray-900">
            <div className="text-center">
              <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4" />
              <p className="text-gray-600 dark:text-gray-400">Carregando documento...</p>
            </div>
          </div>
        );
      }

      if (error || !document) {
        return (
          <div className="min-h-screen flex items-center justify-center p-4 bg-gray-50 dark:bg-gray-900">
            <div className="text-center max-w-md">
              <div className="w-16 h-16 bg-red-100 dark:bg-red-900/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg className="w-8 h-8 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
              </div>
              <h1 className="text-xl font-semibold text-gray-900 dark:text-white mb-2">
                Documento Não Encontrado
              </h1>
              <p className="text-gray-600 dark:text-gray-400 mb-6">
                {error || "Este link pode ter expirado ou o documento não existe."}
              </p>
              <button
                onClick={() => navigate("/")}
                className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors"
              >
                Voltar ao Início
              </button>
            </div>
          </div>
        );
      }

      return (
        <CollaborationRoom documentId={document.id}>
          <div className="min-h-screen bg-gray-50 dark:bg-gray-900">
            {/* Guest Banner - per CONTEXT.md locked decision */}
            {isGuest && <GuestBanner />}

            {/* Header */}
            <header className="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
              <div className="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
                <div>
                  <h1 className="text-xl font-semibold text-gray-900 dark:text-white">
                    {document.title}
                  </h1>
                  <p className="text-sm text-gray-500 dark:text-gray-400">
                    Compartilhado com você
                  </p>
                </div>

                {/* Presence - per CONTEXT.md: guests see full presence */}
                <PresenceList />
              </div>
            </header>

            {/* Document Content with Live Cursors */}
            <main className="max-w-7xl mx-auto px-4 py-8 relative">
              {/* Live cursors overlay */}
              <LiveCursors />

              {/* Document viewer */}
              <div className="bg-white dark:bg-gray-800 rounded-lg shadow-sm p-8">
                {/* TODO: Replace with actual DocumentViewer component */}
                <pre className="whitespace-pre-wrap text-gray-900 dark:text-white">
                  {document.content}
                </pre>
              </div>
            </main>
          </div>
        </CollaborationRoom>
      );
    }

    export default SharedDocument;
    ```
  </action>
  <verify>SharedDocument.tsx renders guest view with presence and cursors</verify>
  <done>Shared document page component</done>
</task>

<task type="auto">
  <name>Add public shared document route</name>
  <files>apps/portal/src/App.tsx</files>
  <action>
    Add public route to App.tsx:

    ```typescript
    import { SharedDocument } from "./pages/SharedDocument";

    // In your routes configuration, add:
    // IMPORTANT: This route must be PUBLIC (no auth requirement)
    <Route path="/shared/:slug" element={<SharedDocument />} />

    // Note: If using ProtectedRoute wrapper, DO NOT wrap this route
    // Guests must be able to access without authentication
    ```
  </action>
  <verify>/shared/:slug route exists without auth requirement</verify>
  <done>Public shared document route</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete guest access for shared documents</what-built>
  <how-to-verify>
    1. Ensure 04-01 is complete (Liveblocks integration works)

    2. Start portal: `cd apps/portal && bun run dev`

    3. Test guest access:
       - Open browser in incognito/private mode (no auth)
       - Navigate to /shared/test-slug (or any slug)
       - Verify page loads without requiring login
       - Verify guest banner appears at top

    4. Test collaboration features for guests:
       - Open same shared document in two windows
       - Window 1: logged in user
       - Window 2: guest (incognito)
       - Verify both see each other's presence
       - Verify both see each other's cursors
       - Verify guest banner shows in window 2 only

    Expected outcomes:
    - Guest can view document without login
    - Guest sees "Visualizando como Convidado" banner
    - Presence works bidirectionally (guest ↔ user)
    - Cursors work bidirectionally (guest ↔ user)
  </how-to-verify>
  <resume-signal>Type "approved" if guest access works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] GuestBanner component shows guest indicator + signup CTA
- [ ] SharedDocument page loads without authentication
- [ ] CollaborationRoom wraps guest document (for presence/cursors)
- [ ] PresenceList works for guest users
- [ ] LiveCursors works for guest users
- [ ] Route /shared/:slug is public (no auth wrapper)
- [ ] Error handling for invalid/expired links
- [ ] E2E test confirms guest can view and collaborate
</verification>

<success_criteria>
1. Guest users can view shared documents (COLL-04)
2. No authentication required
3. Guest banner displayed with signup CTA
4. Full presence/cursor support for guests
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-collaboration/plans/04-03-SUMMARY.md`
</output>

---

**Plan created:** 2026-02-07
**Estimated duration:** 25 min
**Complexity:** Medium (public routing, guest detection, Liveblocks guest support)

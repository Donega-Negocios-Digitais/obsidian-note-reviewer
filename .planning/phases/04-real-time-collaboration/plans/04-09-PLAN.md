---
phase: 04-real-time-collaboration
plan: 09
type: execute
wave: 1
depends_on: []
gap_closure: true
files_modified:
  - apps/portal/src/components/SettingsPanel.tsx
  - apps/portal/src/components/DocumentWorkspace.tsx
autonomous: false

must_haves:
  truths:
    - "VaultPathSelector is accessible from settings or editor"
    - "Users can select Obsidian vault path"
    - "Selected vault persists across sessions"
    - "Vault files can be accessed via File System Access API"
    - "obsidian:// URIs are generated for vault files"
  artifacts:
    - path: "apps/portal/src/components/SettingsPanel.tsx"
      provides: "Settings panel with vault configuration section"
      min_lines: 200
  key_links:
    - from: "apps/portal/src/components/SettingsPanel.tsx"
      to: "apps/portal/src/components/VaultPathSelector"
      via: "import"
      pattern: "VaultPathSelector"
    - from: "apps/portal/src/components/DocumentWorkspace.tsx"
      to: "apps/portal/src/lib/vaultIntegration"
      via: "import" (optional, for direct vault access)
      pattern: "openVault|listVaultFiles"
---

<objective>
Integrate VaultPathSelector into the settings panel so users can configure their Obsidian vault for local file access.

**Purpose:** Close COLL-05 gap - Vault integration files exist but are not integrated into the UI.

**Output:** Vault configuration accessible from Settings panel in the editor.
</objective>

<execution_context>
@C:\Users\Alex\.claude\get-shit-done\workflows\execution-plan.md
@C:\Users\Alex\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
Gap from VERIFICATION.md:
- COLL-05 is FAILED - vault integration files exist but NOT used
- vaultIntegration.ts (154 lines), VaultPathSelector.tsx (133 lines), useObsidianVault.ts (79 lines) all exist
- But NO imports found in main app - components are "orphans"

Existing components (from 04-04):
- apps/portal/src/lib/vaultIntegration.ts (exists, 154 lines)
- apps/portal/src/components/VaultPathSelector.tsx (exists, 133 lines)
- apps/portal/src/hooks/useObsidianVault.ts (exists, 79 lines)

Locked decisions from CONTEXT.md:
- Native workflow with Obsidian vault
- Local vault files can be accessed
- Obsidian links and graph are preserved

Architecture decision from ROADMAP:
- Settings should be in the editor (SettingsPanel), not separate /settings page
</context>

<tasks>

<task type="auto">
  <name>Add vault configuration section to SettingsPanel</name>
  <files>apps/portal/src/components/SettingsPanel.tsx</files>
  <action>
    Add a new settings category for Obsidian vault:

    1. Add import:
    ```typescript
    import { VaultPathSelector } from "@/components/VaultPathSelector";
    ```

    2. Add vault settings section to the categories array:
    ```typescript
    const categories = [
      // ... existing categories ...

      {
        id: 'vault',
        title: 'Obsidian Vault',
        icon: (
          <svg className="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
          </svg>
        ),
        description: 'Configure local Obsidian vault for file access',
      },
    ];
    ```

    3. Add vault content renderer:
    ```typescript
    // In the section where categories render their content
    {activeCategory === 'vault' && (
      <div className="space-y-6">
        <div>
          <h3 className="text-lg font-medium text-gray-900 dark:text-white mb-2">
            Obsidian Vault
          </h3>
          <p className="text-sm text-gray-500 dark:text-gray-400 mb-4">
            Connect your Obsidian vault to access local markdown files directly in the editor.
          </p>
        </div>

        <VaultPathSelector
          onVaultSelected={(vaultPath) => {
            console.log('Vault selected:', vaultPath);
            // Optionally update state or show success message
          }}
        />

        <div className="mt-4 p-4 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
          <h4 className="text-sm font-medium text-blue-900 dark:text-blue-300 mb-2">
            About Vault Integration
          </h4>
          <ul className="text-xs text-blue-800 dark:text-blue-300 space-y-1">
            <li>• Access local Obsidian markdown files directly</li>
            <li>• Preserves Obsidian links and graph structure</li>
            <li>• Files are read from your computer (not uploaded)</li>
            <li>• Requires Chrome or Edge browser</li>
          </ul>
        </div>
      </div>
    )}
    ```
  </action>
  <verify>SettingsPanel has vault category with VaultPathSelector</verify>
  <done>Vault settings section added to SettingsPanel</done>
</task>

<task type="auto">
  <name>Create vault state hook for editor integration</name>
  <files>apps/portal/src/hooks/useVaultState.ts</files>
  <action>
    Create a hook to share vault state across the app:

    ```typescript
    /**
     * Vault State Hook
     *
     * Global state for Obsidian vault configuration.
     * Allows DocumentWorkspace to access vault files.
     */

    import { useState, useEffect } from 'react';
    import { getVaultConfig, type VaultConfig } from '@/lib/vaultIntegration';

    interface VaultState {
      vaultPath: string | null;
      isConnected: boolean;
    }

    let globalVaultState: VaultState = {
      vaultPath: null,
      isConnected: false,
    };
    const listeners = new Set<(state: VaultState) => void>();

    function notifyListeners() {
      listeners.forEach(listener => listener({ ...globalVaultState }));
    }

    export function useVaultState() {
      const [state, setState] = useState<VaultState>({ ...globalVaultState });

      useEffect(() => {
        // Load initial state
        const config = getVaultConfig();
        if (config) {
          globalVaultState = {
            vaultPath: config.path,
            isConnected: true,
          };
          setState({ ...globalVaultState });
        }

        // Listen for changes
        listeners.add(setState);

        return () => {
          listeners.delete(setState);
        };
      }, []);

      return state;
    }

    export function updateVaultState(vaultPath: string | null) {
      if (vaultPath) {
        globalVaultState = {
          vaultPath,
          isConnected: true,
        };
      } else {
        globalVaultState = {
          vaultPath: null,
          isConnected: false,
        };
      }
      notifyListeners();
    }
    ```
  </action>
  <verify>useVaultState hook created with global state management</verify>
  <done>Vault state hook for editor integration</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete vault UI integration</what-built>
  <how-to-verify>
    1. Start portal: cd apps/portal && bun run dev

    2. Open a document in the editor

    3. Open Settings panel (click settings icon/button)

    4. Select "Obsidian Vault" category

    5. Verify vault selector UI:
       - Vault description is visible
       - "Selecionar Vault" button is shown
       - Browser compatibility note is displayed

    6. Test vault selection (Chrome or Edge only):
       - Click "Selecionar Vault"
       - Verify folder picker opens
       - Select an Obsidian vault folder
       - Verify vault name displays with green success indicator
       - Verify "Conectado em [date]" shows

    7. Test persistence:
       - Close settings panel
       - Refresh page
       - Open settings again
       - Verify vault selection is remembered

    8. Test clear:
       - Click "Remover" button
       - Verify "Nenhum vault selecionado" shows

    Expected outcomes:
    - Vault settings accessible from editor
    - Vault picker opens in Chrome/Edge
    - Selected vault persists across sessions
  </how-to-verify>
  <resume-signal>Type "approved" if vault UI integration works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] SettingsPanel has vault category
- [ ] VaultPathSelector imported and rendered
- [ ] Vault description and help text visible
- [ ] useVaultState hook created for state sharing
- [ ] Vault selection works in Chrome/Edge
- [ ] Vault persists in localStorage
- [ ] Browser compatibility warning shows in unsupported browsers
</verification>

<success_criteria>
1. Vault configuration accessible from Settings panel
2. Users can select Obsidian vault path
3. Selected vault persists across sessions
4. COLL-05 fully satisfied - vault workflow integrated
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-collaboration/plans/04-09-SUMMARY.md`
</output>

---

**Plan created:** 2026-02-07
**Estimated duration:** 30 min
**Complexity:** Medium (Settings integration, state management, browser compatibility)

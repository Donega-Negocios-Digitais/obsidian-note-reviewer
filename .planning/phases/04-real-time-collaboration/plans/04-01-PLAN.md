---
phase: 04-real-time-collaboration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/portal/package.json
  - apps/portal/src/lib/liveblocks.ts
  - apps/portal/src/lib/cursor-colors.ts
  - apps/portal/src/lib/liveblocks-auth.ts
  - apps/portal/src/components/collaboration/RoomProvider.tsx
  - apps/portal/src/components/collaboration/PresenceList.tsx
autonomous: false

user_setup:
  - service: liveblocks
    why: "Real-time presence and cursor tracking"
    env_vars:
      - name: VITE_LIVEBLOCKS_PUBLIC_KEY
        source: "Liveblocks Dashboard -> Create App -> API Keys -> Public Key"
      - name: LIVEBLOCKS_SECRET_KEY
        source: "Liveblocks Dashboard -> Create App -> API Keys -> Secret Key"

must_haves:
  truths:
    - "Liveblocks client is configured with room provider"
    - "Presence list shows active users with avatars and names"
    - "User colors are generated consistently from username (color-hash)"
    - "Users can see who else is viewing the same document"
    - "Presence updates automatically when users join/leave"
  artifacts:
    - path: "apps/portal/src/lib/liveblocks.ts"
      provides: "Liveblocks client configuration"
      exports: ["createClient"]
      min_lines: 20
    - path: "apps/portal/src/lib/cursor-colors.ts"
      provides: "Color generation from usernames (color-hash library)"
      exports: ["getCursorColor"]
      min_lines: 15
    - path: "apps/portal/src/lib/liveblocks-auth.ts"
      provides: "Auth endpoint wrapper for Liveblocks"
      exports: ["getLiveblocksToken"]
      min_lines: 30
    - path: "apps/portal/src/components/collaboration/RoomProvider.tsx"
      provides: "Liveblocks RoomProvider wrapper for document reviews"
      min_lines: 50
    - path: "apps/portal/src/components/collaboration/PresenceList.tsx"
      provides: "UI component showing active users with avatars"
      min_lines: 80
  key_links:
    - from: "apps/portal/src/components/collaboration/RoomProvider.tsx"
      to: "apps/portal/src/lib/liveblocks.ts"
      via: "import"
      pattern: "createClient"
    - from: "apps/portal/src/components/collaboration/PresenceList.tsx"
      to: "apps/portal/src/lib/cursor-colors.ts"
      via: "import"
      pattern: "getCursorColor"
---

<objective>
Integrate Liveblocks v3.13.4 for real-time presence tracking, enabling users to see who else is viewing the document with visual indicators (avatars, names, colors).

**Purpose:** Deliver COLL-01 requirement - presence indicators showing who else is viewing the document.

**Output:** Complete Liveblocks integration with color-hash library and presence UI components.
</objective>

<execution_context>
@C:\Users\Alex\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Alex\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/phases/04-real-time-collaboration/04-CONTEXT.md
@.planning/phases/04-real-time-collaboration/04-RESEARCH.md
@.planning/STATE.md

User locked decisions (from CONTEXT.md):
- **Lista de usuarios ativos**: Mostrar lista completa com avatares e nomes (nao apenas contador)
- **Estilo de avatares**: Avatares coloridos (pixel art 16x16, GitHub-style, ou silhuetas estilizadas)
- **Indicador de status**: Mostrar "Fulano est digitando..." proximo ao avatar/nome
- **Animacao de entrada/saida**: Fade suave (fade in/out) ao aparecer/desaparecer da sessao

Research recommendations:
- Use @liveblocks/react@3.13.4 (latest version)
- Use color-hash@2.0.2 library for color generation
- Follow Liveblocks RoomProvider pattern
- Client-side auth endpoint for Liveblocks

Existing codebase:
- Supabase Auth already implemented (Phase 1)
- Portal app structure exists
- React Router for navigation
</context>

<tasks>

<task type="auto">
  <name>Add Liveblocks dependencies</name>
  <files>apps/portal/package.json</files>
  <action>
    1. Add to apps/portal/package.json dependencies:
    ```json
    "@liveblocks/react": "^3.13.4",
    "@liveblocks/node": "^3.13.4",
    "color-hash": "^2.0.2"
    ```

    2. Install dependencies:
    ```bash
    cd apps/portal && bun install
    ```

    NOTE: Using v3.13.4 per RESEARCH.md recommendation (not v2.12.0 from old plan)
  </action>
  <verify>package.json contains @liveblocks/react@3.13.4, @liveblocks/node@3.13.4, color-hash@2.0.2</verify>
  <done>Liveblocks dependencies installed</done>
</task>

<task type="auto">
  <name>Create Liveblocks client configuration</name>
  <files>apps/portal/src/lib/liveblocks.ts</files>
  <action>
    Create apps/portal/src/lib/liveblocks.ts:

    ```typescript
    /**
     * Liveblocks Client Configuration
     *
     * Real-time presence and cursor tracking setup.
     */

    import { createClient } from "@liveblocks/core";
    import { createClientContext } from "@liveblocks/react";

    // Create Liveblocks client
    export const liveblocksClient = createClient({
      authEndpoint: "/api/liveblocks-auth",
      throttle: 100,
    });

    // Create React context for easy access
    export const LiveblocksClientProvider = createClientContext(liveblocksClient);
    ```
  </action>
  <verify>liveblocks.ts exports liveblocksClient and LiveblocksClientProvider</verify>
  <done>Liveblocks client configuration</done>
</task>

<task type="auto">
  <name>Create cursor color utilities (color-hash library)</name>
  <files>apps/portal/src/lib/cursor-colors.ts</files>
  <action>
    Create apps/portal/src/lib/cursor-colors.ts:

    ```typescript
    /**
     * Cursor Color Utilities
     *
     * Consistent color generation from usernames using color-hash library.
     * Per CONTEXT.md: "Cores dos cursores: Gerada automaticamente por usuario (hash do nome -> cor unica)"
     */

    import ColorHash from "color-hash";

    const colorHash = new ColorHash({
      hue: { min: 0, max: 360 },
      saturation: [0.6, 0.8],  // Avoid too light/dark
      lightness: [0.4, 0.6],
    });

    /**
     * Get consistent color for username
     */
    export function getCursorColor(name: string): string {
      return colorHash.hex(name);
    }

    /**
     * Get initial avatar color (lighter version for background)
     */
    export function getAvatarColor(name: string): string {
      const color = getCursorColor(name);
      // Convert to lighter variant for avatar background
      return color;
    }
    ```
  </action>
  <verify>cursor-colors.ts exports getCursorColor and getAvatarColor</verify>
  <done>Cursor color utilities using color-hash library</done>
</task>

<task type="auto">
  <name>Create Liveblocks auth wrapper</name>
  <files>apps/portal/src/lib/liveblocks-auth.ts</files>
  <action>
    Create apps/portal/src/lib/liveblocks-auth.ts:

    ```typescript
    /**
     * Liveblocks Auth Wrapper
     *
     * Helper for calling Liveblocks auth endpoint.
     */

    interface AuthResponse {
      token: string;
      error?: string;
    }

    export async function getLiveblocksToken(roomId: string): Promise<AuthResponse> {
      try {
        const response = await fetch("/api/liveblocks-auth", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ roomId }),
        });

        if (!response.ok) {
          throw new Error(`Auth failed: ${response.statusText}`);
        }

        const data = await response.json();
        return { token: data.token };
      } catch (error) {
        console.error("Liveblocks auth error:", error);
        return { token: "", error: "Failed to authenticate" };
      }
    }
    ```
  </action>
  <verify>liveblocks-auth.ts exports getLiveblocksToken</verify>
  <done>Liveblocks auth wrapper</done>
</task>

<task type="auto">
  <name>Create Liveblocks RoomProvider wrapper</name>
  <files>apps/portal/src/components/collaboration/RoomProvider.tsx</files>
  <action>
    Create apps/portal/src/components/collaboration/RoomProvider.tsx:

    ```typescript
    /**
     * Liveblocks Room Provider
     *
     * Wrapper component for Liveblocks RoomProvider.
     * Handles room lifecycle for document collaboration.
     */

    import { ReactNode } from "react";
    import { RoomProvider as LiveblocksRoomProvider } from "@liveblocks/react";
    import type { RoomProviderProps } from "@liveblocks/react";

    interface CollaborationRoomProps {
      children: ReactNode;
      documentId: string;
      initialPresence?: Record<string, unknown>;
    }

    export function CollaborationRoom({
      children,
      documentId,
      initialPresence = {},
    }: CollaborationRoomProps) {
      const roomId = `doc-${documentId}`;

      return (
        <LiveblocksRoomProvider
          id={roomId}
          initialPresence={initialPresence}
        >
          {children}
        </LiveblocksRoomProvider>
      );
    }
    ```
  </action>
  <verify>RoomProvider.tsx exports CollaborationRoom component</verify>
  <done>RoomProvider wrapper component</done>
</task>

<task type="auto">
  <name>Create PresenceList component (locked decision: lista completa com avatares)</name>
  <files>apps/portal/src/components/collaboration/PresenceList.tsx</files>
  <action>
    Create apps/portal/src/components/collaboration/PresenceList.tsx:

    ```typescript
    /**
     * Presence List Component
     *
     * Shows active users in the current document.
     * Per CONTEXT.md locked decision: "Lista de usuarios ativos: Mostrar lista completa com avatares e nomes (nao apenas contador)"
     */

    import { useOthers, useSelf } from "@liveblocks/react";
    import { getCursorColor } from "@/lib/cursor-colors";
    {/*
    TODO: After creating Cursor.tsx in 04-02, add:
    import { Cursor } from "./Cursor";
    */}

    export function PresenceList() {
      const others = useOthers();
      const self = useSelf();

      return (
        <div className="flex items-center gap-2 p-2 bg-white dark:bg-gray-800 rounded-lg shadow-sm">
          {/* Self indicator */}
          {self && (
            <SelfAvatar
              name={self.info.name as string || "Você"}
              color={getCursorColor(self.info.name as string || "default")}
              avatar={self.info.avatar as string | undefined}
            />
          )}

          {/* Other users - fade in/out animation */}
          {others.map((other) => (
            <div
              key={other.connectionId}
              className="animate-in fade-in duration-300"
            >
              <OtherUserAvatar
                name={other.info.name as string}
                color={getCursorColor(other.info.name as string)}
                avatar={other.info.avatar as string | undefined}
                isTyping={other.presence.isTyping as boolean | undefined}
              />
            </div>
          ))}
        </div>
      );
    }

    interface AvatarProps {
      name: string;
      color: string;
      avatar?: string;
    }

    function SelfAvatar({ name, color, avatar }: AvatarProps) {
      return (
        <div
          className="relative group"
          title={`${name} (você)`}
        >
          <div
            className="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium border-2 border-blue-500"
            style={{ backgroundColor: color }}
          >
            {avatar ? (
              <img
                src={avatar}
                alt={name}
                className="w-full h-full rounded-full object-cover"
              />
            ) : (
              <span>{getInitials(name)}</span>
            )}
          </div>
        </div>
      );
    }

    interface OtherUserAvatarProps extends AvatarProps {
      isTyping?: boolean;
    }

    function OtherUserAvatar({ name, color, avatar, isTyping }: OtherUserAvatarProps) {
      return (
        <div className="relative group">
          <div
            className="w-8 h-8 rounded-full flex items-center justify-center text-white text-sm font-medium border-2 border-white dark:border-gray-800"
            style={{ backgroundColor: color }}
            title={name}
          >
            {avatar ? (
              <img
                src={avatar}
                alt={name}
                className="w-full h-full rounded-full object-cover"
              />
            ) : (
              <span>{getInitials(name)}</span>
            )}
          </div>

          {/* Tooltip */}
          <div className="absolute bottom-full left-1/2 -translate-x-1/2 mb-2 px-2 py-1 bg-gray-800 text-white text-xs rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">
            {name}
          </div>

          {/* Typing indicator - per CONTEXT.md locked decision */}
          {isTyping && (
            <span className="absolute -bottom-4 left-1/2 -translate-x-1/2 text-[10px] text-gray-500 whitespace-nowrap animate-pulse">
              digitando...
            </span>
          )}
        </div>
      );
    }

    function getInitials(name: string): string {
      return name
        .split(" ")
        .map((n) => n[0])
        .join("")
        .toUpperCase()
        .slice(0, 2);
    }
    ```
  </action>
  <verify>PresenceList.tsx shows avatars with names, typing indicator, and fade animation</verify>
  <done>Presence list component with locked decisions implemented</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Liveblocks integration with presence list</what-built>
  <how-to-verify>
    1. Set environment variables (user setup required):
       - VITE_LIVEBLOCKS_PUBLIC_KEY in .env
       - LIVEBLOCKS_SECRET_KEY in .env (for server-side)

    2. Create Liveblocks app at https://liveblocks.io/dashboard if needed

    3. Start portal: `cd apps/portal && bun run dev`

    4. Open same document in two browser windows (incognito for different session)

    5. Verify:
       - Presence list shows avatars in both windows
       - Avatars have different colors (color-hash from username)
       - Names show on hover
       - Presence appears with fade-in animation
       - Cursor position shows in both windows (after 04-02 implementation)

    Expected outcomes:
    - Both windows see each other's presence
    - Colors are consistent per username (color-hash)
    - Fade animation works on join/leave
  </how-to-verify>
  <resume-signal>Type "approved" if presence works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] @liveblocks/react@3.13.4, @liveblocks/node@3.13.4, color-hash@2.0.2 installed
- [ ] liveblocks.ts creates client with authEndpoint
- [ ] cursor-colors.ts uses color-hash library (not custom implementation)
- [ ] liveblocks-auth.ts wrapper for auth endpoint
- [ ] RoomProvider wraps Liveblocks RoomProvider
- [ ] PresenceList shows complete list with avatars (not just counter)
- [ ] Typing indicator "digitando..." shows when isTyping is true
- [ ] Fade-in animation on user join
- [ ] E2E test confirms presence in multiple windows
</verification>

<success_criteria>
1. Presence indicators show who else is viewing (COLL-01)
2. Avatars with consistent colors from username hash
3. Complete user list (not counter) per locked decision
4. Fade animations per locked decision
5. Typing indicator per locked decision
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-collaboration/plans/04-01-SUMMARY.md`
</output>

---

**Plan created:** 2026-02-07
**Estimated duration:** 25 min
**Complexity:** Medium (Liveblocks integration, color-hash library, presence UI)

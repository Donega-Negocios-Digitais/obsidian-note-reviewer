---
phase: 04-real-time-collaboration
plan: 06
type: execute
wave: 1
depends_on: []
gap_closure: true
files_modified:
  - apps/portal/dev-server.ts
  - apps/portal/.env.local
autonomous: false

must_haves:
  truths:
    - "Server-side /api/liveblocks-auth endpoint exists in dev-server.ts"
    - "Endpoint uses LIVEBLOCKS_SECRET_KEY for authorization"
    - "Endpoint returns token for Liveblocks client authentication"
    - "Environment variable LIVEBLOCKS_SECRET_KEY is documented"
  artifacts:
    - path: "apps/portal/dev-server.ts"
      provides: "Server endpoint for Liveblocks authentication"
      exports: ["/api/liveblocks-auth route"]
      min_lines: 30
  key_links:
    - from: "apps/portal/src/lib/liveblocks.ts"
      to: "apps/portal/dev-server.ts"
      via: "authEndpoint"
      pattern: "/api/liveblocks-auth"
---

<objective>
Create server-side /api/liveblocks-auth endpoint in dev-server.ts to enable Liveblocks real-time features.

**Purpose:** Close COLL-01 and COLL-02 gap - Liveblocks client requires auth endpoint that currently doesn't exist.

**Output:** Working /api/liveblocks-auth endpoint that authorizes Liveblocks connections.
</objective>

<execution_context>
@C:\Users\Alex\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Alex\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
Gap from VERIFICATION.md:
- COLL-01 & COLL-02 are PARTIAL because authEndpoint="/api/liveblocks-auth" does not exist
- All Liveblocks components (PresenceList, Cursor, LiveCursors) are blocked by this
- Server endpoint needed to authorize Liveblocks connections

Existing components waiting for this endpoint:
- apps/portal/src/lib/liveblocks.ts (authEndpoint: "/api/liveblocks-auth")
- apps/portal/src/lib/liveblocks-auth.ts (fetch("/api/liveblocks-auth"))
- apps/portal/src/components/collaboration/RoomProvider.tsx
- apps/portal/src/components/collaboration/PresenceList.tsx
- apps/portal/src/components/collaboration/Cursor.tsx
- apps/portal/src/components/collaboration/LiveCursors.tsx
- apps/portal/src/hooks/useCursorTracking.ts

User Setup Required:
- Liveblocks account at https://liveblocks.io
- LIVEBLOCKS_SECRET_KEY from dashboard
</context>

<tasks>

<task type="auto">
  <name>Add Liveblocks dependency to dev-server</name>
  <files>apps/portal/package.json</files>
  <action>
    Ensure @liveblocks/node is in dev dependencies (already added in 04-01):

    ```bash
    cd apps/portal && bun install
    ```

    Verify @liveblocks/node@^3.13.4 is installed.
  </action>
  <verify>@liveblocks/node is installed in node_modules</verify>
  <done>Liveblocks server dependency installed</done>
</task>

<task type="auto">
  <name>Create /api/liveblocks-auth endpoint in dev-server.ts</name>
  <files>apps/portal/dev-server.ts</files>
  <action>
    Add the Liveblocks auth endpoint to dev-server.ts:

    ```typescript
    import { Liveblocks } from "@liveblocks/node";
    import type { AuthorizeResult } from "@liveblocks/node";

    // Initialize Liveblocks with secret key
    const liveblocks = new Liveblocks({
      secret: process.env.LIVEBLOCKS_SECRET_KEY || "",
    });

    // Add to server API routes (after other routes)
    server.post('/api/liveblocks-auth', async (req, res) => {
      try {
        // Get roomId from request body
        const { roomId } = req.body;

        if (!roomId) {
          return res.status(400).json({ error: 'roomId is required' });
        }

        // Get user from session (if authenticated)
        // For dev purposes, allow anonymous access with a default user
        const userId = req.session?.user?.id || 'anonymous-user';
        const userName = req.session?.user?.name || 'Anonymous User';

        // Authorize the room access
        const result: AuthorizeResult = await liveblocks.authorize({
          room: roomId,
          userId: userId,
        });

        // Return the token to the client
        if (result.error) {
          return res.status(403).json({ error: result.error.message });
        }

        return res.json({ token: result.data?.token });
      } catch (error) {
        console.error('Liveblocks auth error:', error);
        return res.status(500).json({ error: 'Authentication failed' });
      }
    });
    ```

    Note: This endpoint authorizes access to Liveblocks rooms using the secret key.
    For production, you should validate the user is authenticated and has access to the specific room.
  </action>
  <verify>/api/liveblocks-auth route exists in dev-server.ts</verify>
  <done>Liveblocks auth endpoint created</done>
</task>

<task type="auto">
  <name>Add environment variable documentation</name>
  <files>apps/portal/.env.example</files>
  <action>
    Add LIVEBLOCKS_SECRET_KEY to .env.example:

    ```bash
    # Liveblocks Configuration
    LIVEBLOCKS_SECRET_KEY=sk_liveblocks_secret_key_from_dashboard
    VITE_LIVEBLOCKS_PUBLIC_KEY=pk_liveblocks_public_key_from_dashboard
    ```

    Create or update README section with setup instructions.
  </action>
  <verify>.env.example contains LIVEBLOCKS_SECRET_KEY</verify>
  <done>Environment variable documented</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Liveblocks auth endpoint</what-built>
  <how-to-verify>
    1. Set LIVEBLOCKS_SECRET_KEY in .env.local:
       ```bash
       LIVEBLOCKS_SECRET_KEY=sk_your_secret_key
       ```

    2. Start dev server:
       ```bash
       cd apps/portal && bun run dev
       ```

    3. Test the endpoint:
       ```bash
       curl -X POST http://localhost:5173/api/liveblocks-auth \
         -H "Content-Type: application/json" \
         -d '{"roomId":"test-room"}'
       ```

    4. Expected response:
       ```json
       { "token": "eyJhbGc..." }
       ```

    5. Verify no errors in console about missing auth endpoint

    Expected outcomes:
    - Endpoint returns valid Liveblocks token
    - No "authEndpoint not found" errors
    - PresenceList and other components can now connect
  </how-to-verify>
  <resume-signal>Type "approved" if auth endpoint works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] @liveblocks/node is installed
- [ ] /api/liveblocks-auth route exists in dev-server.ts
- [ ] Endpoint uses LIVEBLOCKS_SECRET_KEY
- [ ] Endpoint returns { token: string } response
- [ ] .env.example documents LIVEBLOCKS_SECRET_KEY
- [ ] curl test returns valid token
</verification>

<success_criteria>
1. Server-side /api/liveblocks-auth endpoint exists
2. Endpoint authorizes Liveblocks connections
3. Liveblocks client can successfully authenticate
4. COLL-01 and COLL-02 no longer blocked by missing auth
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-collaboration/plans/04-06-SUMMARY.md`
</output>

---

**Plan created:** 2026-02-07
**Estimated duration:** 20 min
**Complexity:** Medium (Liveblocks server auth, environment setup)

---
phase: 04-real-time-collaboration
plan: 07
type: execute
wave: 2
depends_on: ["04-06"]
gap_closure: true
files_modified:
  - apps/portal/src/components/DocumentWorkspace.tsx
  - apps/portal/src/lib/roomUtils.ts
autonomous: false

must_haves:
  truths:
    - "DocumentWorkspace is wrapped with CollaborationRoom"
    - "PresenceList shows active users in main editor"
    - "LiveCursors component renders in main editor"
    - "useCursorTracking hook is active in main editor"
    - "Collaboration features work in main editor (not just SharedDocument)"
  artifacts:
    - path: "apps/portal/src/components/DocumentWorkspace.tsx"
      provides: "Main editor with real-time collaboration"
      min_lines: 150
    - path: "apps/portal/src/lib/roomUtils.ts"
      provides: "Utility for generating room IDs from document IDs"
      exports: ["getRoomId"]
      min_lines: 15
  key_links:
    - from: "apps/portal/src/components/DocumentWorkspace.tsx"
      to: "apps/portal/src/components/collaboration/CollaborationRoom"
      via: "import"
      pattern: "CollaborationRoom"
    - from: "apps/portal/src/components/DocumentWorkspace.tsx"
      to: "apps/portal/src/components/collaboration/PresenceList"
      via: "import"
      pattern: "PresenceList"
    - from: "apps/portal/src/components/DocumentWorkspace.tsx"
      to: "apps/portal/src/components/collaboration/LiveCursors"
      via: "import"
      pattern: "LiveCursors"
    - from: "apps/portal/src/components/DocumentWorkspace.tsx"
      to: "apps/portal/src/hooks/useCursorTracking"
      via: "import"
      pattern: "useCursorTracking"
---

<objective>
Integrate CollaborationRoom, PresenceList, and LiveCursors into DocumentWorkspace so real-time collaboration works in the main editor (not just in SharedDocument page).

**Purpose:** Close COLL-01 and COLL-02 gap - collaboration components only exist in SharedDocument, not main editor.

**Output:** Main editor with live presence indicators and cursor tracking.
</objective>

<execution_context>
@C:\Users\Alex\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Alex\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
Gap from VERIFICATION.md:
- COLL-01 & COLL-02 are PARTIAL because components only in SharedDocument.tsx
- DocumentWorkspace.tsx does NOT use CollaborationRoom, PresenceList, or LiveCursors
- Key link: DocumentWorkspace.tsx â†’ CollaborationRoom = NOT_WIRED

Existing components that need integration:
- apps/portal/src/components/collaboration/CollaborationRoom.tsx (77 lines)
- apps/portal/src/components/collaboration/PresenceList.tsx (229 lines)
- apps/portal/src/components/collaboration/LiveCursors.tsx (37 lines)
- apps/portal/src/hooks/useCursorTracking.ts (94 lines)
- apps/portal/src/hooks/useSelectionTracking.ts (in useCursorTracking.ts)

Locked decisions from CONTEXT.md:
- Presence list should be visible in main editor
- Real-time cursors should be visible when multiple users are viewing
- Fade animations for user join/leave
</context>

<tasks>

<task type="auto">
  <name>Create room utility for consistent room IDs</name>
  <files>apps/portal/src/lib/roomUtils.ts</files>
  <action>
    Create apps/portal/src/lib/roomUtils.ts:

    ```typescript
    /**
     * Room Utilities
     *
     * Generate consistent room IDs for Liveblocks collaboration.
     */

    /**
     * Get room ID for a document
     * Format: doc-{documentId}
     */
    export function getRoomId(documentId: string): string {
      return `doc-${documentId}`;
    }

    /**
     * Extract document ID from room ID
     * Format: doc-{documentId} -> {documentId}
     */
    export function getDocumentIdFromRoom(roomId: string): string | null {
      const match = roomId.match(/^doc-(.+)$/);
      return match ? match[1] : null;
    }
    ```
  </action>
  <verify>roomUtils.ts exports getRoomId and getDocumentIdFromRoom</verify>
  <done>Room utility created</done>
</task>

<task type="auto">
  <name>Integrate CollaborationRoom into DocumentWorkspace</name>
  <files>apps/portal/src/components/DocumentWorkspace.tsx</files>
  <action>
    Wrap DocumentWorkspace with CollaborationRoom:

    1. Add imports:
    ```typescript
    import { CollaborationRoom } from "@/components/collaboration/RoomProvider";
    import { getRoomId } from "@/lib/roomUtils";
    import { PresenceList } from "@/components/collaboration/PresenceList";
    import { LiveCursors } from "@/components/collaboration/LiveCursors";
    import { useCursorTracking, useSelectionTracking } from "@/hooks/useCursorTracking";
    ```

    2. Wrap the main content with CollaborationRoom:
    ```typescript
    export function DocumentWorkspace({ documentId, ...props }: DocumentWorkspaceProps) {
      const roomId = getRoomId(documentId);

      // Enable cursor tracking
      useCursorTracking();
      useSelectionTracking();

      return (
        <CollaborationRoom documentId={documentId}>
          {/* Existing editor content */}
          <div className="relative">
            {/* Live cursors overlay */}
            <LiveCursors />

            {/* Existing workspace content */}
            <div className="workspace-content">
              {/* ... existing content ... */}
            </div>

            {/* Presence indicator */}
            <div className="presence-bar">
              <PresenceList />
            </div>
          </div>
        </CollaborationRoom>
      );
    }
    ```

    Adjust the structure to match your existing DocumentWorkspace layout.
    The key is to wrap the content with CollaborationRoom and include LiveCursors + PresenceList.
  </action>
  <verify>DocumentWorkspace imports and uses CollaborationRoom, PresenceList, LiveCursors, useCursorTracking</verify>
  <done>Collaboration components integrated into main editor</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete collaboration integration in main editor</what-built>
  <how-to-verify>
    1. Ensure 04-06 (auth endpoint) is complete

    2. Start portal: cd apps/portal && bun run dev

    3. Open a document in the main editor

    4. Open same document in second browser window (incognito)

    5. Verify collaboration features in MAIN EDITOR:
       - Presence list shows avatars of both users
       - Cursor appears in other window when moving mouse
       - Cursor has correct color from username hash
       - Name tooltip shows above cursor
       - Typing indicator appears when typing

    Expected outcomes:
    - Main editor has all collaboration features
    - Works the same as SharedDocument page
    - Multiple users can collaborate in real-time
  </how-to-verify>
  <resume-signal>Type "approved" if main editor collaboration works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] roomUtils.ts created with getRoomId function
- [ ] DocumentWorkspace wrapped with CollaborationRoom
- [ ] PresenceList added to DocumentWorkspace
- [ ] LiveCursors added to DocumentWorkspace
- [ ] useCursorTracking called in DocumentWorkspace
- [ ] useSelectionTracking called in DocumentWorkspace
- [ ] E2E test confirms collaboration in main editor
</verification>

<success_criteria>
1. Main editor (DocumentWorkspace) has real-time collaboration
2. Presence indicators show active users
3. Cursors appear and track in real-time
4. COLL-01 and COLL-02 fully satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-collaboration/plans/04-07-SUMMARY.md`
</output>

---

**Plan created:** 2026-02-07
**Estimated duration:** 25 min
**Complexity:** Medium (Component integration, layout adjustments)

---
phase: 04-real-time-collaboration
plan: 04
type: execute
wave: 3
depends_on: []
files_modified:
  - apps/portal/src/lib/vaultIntegration.ts
  - apps/portal/src/components/VaultPathSelector.tsx
  - apps/portal/src/hooks/useObsidianVault.ts
autonomous: false

must_haves:
  truths:
    - "Users can select their Obsidian vault path"
    - "Local markdown files can be accessed via File System Access API"
    - "Obsidian links and graph are preserved"
    - "Vault path is stored in localStorage for persistence"
    - "Vault selection works in Chrome/Edge (API support detection)"
  artifacts:
    - path: "apps/portal/src/lib/vaultIntegration.ts"
      provides: "File System Access API utilities for vault access"
      exports: ["openVault", "readVaultFile", "listVaultFiles", "isSupported"]
      min_lines: 120
    - path: "apps/portal/src/components/VaultPathSelector.tsx"
      provides: "UI component for selecting vault path"
      min_lines: 80
    - path: "apps/portal/src/hooks/useObsidianVault.ts"
      provides: "React hook for vault state management"
      min_lines: 60
  key_links:
    - from: "apps/portal/src/components/VaultPathSelector.tsx"
      to: "apps/portal/src/lib/vaultIntegration.ts"
      via: "import"
      pattern: "openVault|isSupported"
    - from: "apps/portal/src/hooks/useObsidianVault.ts"
      to: "apps/portal/src/lib/vaultIntegration.ts"
      via: "import"
      pattern: "getVaultConfig|openVault"

---

<objective>
Create Obsidian vault integration for local file access using File System Access API, allowing users to select their vault and read local markdown files while preserving Obsidian links and graph structure.

**Purpose:** Deliver COLL-05 requirement - native workflow with Obsidian vault.

**Output:** Complete vault integration with file picker and local file access.
</objective>

<execution_context>
@C:\Users\Alex\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Alex\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/phases/04-real-time-collaboration/04-CONTEXT.md
@.planning/phases/04-real-time-collaboration/04-RESEARCH.md

User locked decisions (from CONTEXT.md):
- Native workflow with Obsidian vault (COLL-05)
- Local vault files can be accessed
- Obsidian links and graph are preserved

Research recommendations:
- Use File System Access API (window.showDirectoryPicker)
- Only works in HTTPS (or localhost)
- Chrome/Edge only (Firefox/Safari limited support)
- Permission-based access (request permission once)
- obsidian:// protocol for deep links

Limitations:
- Requires HTTPS (or localhost)
- Chrome/Edge only (Firefox/Safari limited)
- Requires user gesture (button click)
</context>

<tasks>

<task type="auto">
  <name>Create vault integration utilities (File System Access API)</name>
  <files>apps/portal/src/lib/vaultIntegration.ts</files>
  <action>
    Create apps/portal/src/lib/vaultIntegration.ts:

    ```typescript
    /**
     * Obsidian Vault Integration
     *
     * File System Access API utilities for local vault access.
     * Allows reading local Obsidian vaults in the browser.
     *
     * Per RESEARCH.md: Only works in HTTPS (or localhost), Chrome/Edge only
     */

    export interface VaultHandle {
      handle: FileSystemDirectoryHandle;
      path: string;
      name: string;
    }

    export interface VaultFile {
      name: string;
      path: string;
      handle: FileSystemFileHandle;
    }

    export interface VaultConfig {
      path: string;
      lastAccess: string;
    }

    const STORAGE_KEY = 'obsreview-vault-config';

    /**
     * Open Obsidian vault using File System Access API
     */
    export async function openVault(): Promise<VaultHandle | null> {
      try {
        const handle = await window.showDirectoryPicker({
          mode: 'read',
          startIn: 'documents',
        });

        const vaultHandle: VaultHandle = {
          handle,
          path: handle.name,
          name: handle.name,
        };

        // Save to localStorage
        const config: VaultConfig = {
          path: handle.name,
          lastAccess: new Date().toISOString(),
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(config));

        return vaultHandle;
      } catch (error) {
        if (error instanceof Error && error.name === 'AbortError') {
          // User cancelled
          return null;
        }
        console.error('Failed to open vault:', error);
        throw error;
      }
    }

    /**
     * List all markdown files in vault
     */
    export async function listVaultFiles(vault: VaultHandle): Promise<VaultFile[]> {
      const files: VaultFile[] = await scanDirectory(vault.handle, '');

      return files.filter((f) => f.name.endsWith('.md'));
    }

    /**
     * Recursively scan directory for files
     */
    async function scanDirectory(
      dirHandle: FileSystemDirectoryHandle,
      path: string
    ): Promise<VaultFile[]> {
      const files: VaultFile[] = [];

      for await (const entry of dirHandle.values()) {
        const entryPath = path ? `${path}/${entry.name}` : entry.name;

        if (entry.kind === 'file') {
          files.push({
            name: entry.name,
            path: entryPath,
            handle: entry as FileSystemFileHandle,
          });
        } else if (entry.kind === 'directory') {
          // Skip .obsidian and hidden directories
          if (entry.name.startsWith('.') || entry.name === 'node_modules') {
            continue;
          }

          const subFiles = await scanDirectory(
            entry as FileSystemDirectoryHandle,
            entryPath
          );
          files.push(...subFiles);
        }
      }

      return files;
    }

    /**
     * Read a file from vault
     */
    export async function readVaultFile(file: VaultFile): Promise<string> {
      const fileData = await file.handle.getFile();
      const text = await fileData.text();
      return text;
    }

    /**
     * Get saved vault config
     */
    export function getVaultConfig(): VaultConfig | null {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        try {
          return JSON.parse(stored);
        } catch {
          return null;
        }
      }
      return null;
    }

    /**
     * Check if File System Access API is supported
     */
    export function isSupported(): boolean {
      return 'showDirectoryPicker' in window;
    }

    /**
     * Clear saved vault config
     */
    export function clearVaultConfig(): void {
      localStorage.removeItem(STORAGE_KEY);
    }

    /**
     * Generate obsidian:// URI for a file
     * Per RESEARCH.md: Format is obsidian://vault/path/to/file
     */
    export function getObsidianUri(vaultName: string, filePath: string): string {
      return `obsidian://${encodeURIComponent(vaultName)}/${encodeURIComponent(filePath)}`;
    }

    // Export types
    export type { VaultHandle, VaultFile, VaultConfig };
    ```
  </action>
  <verify>vaultIntegration.ts exports openVault, listVaultFiles, readVaultFile, isSupported, getObsidianUri</verify>
  <done>Vault integration utilities</done>
</task>

<task type="auto">
  <name>Create useObsidianVault hook</name>
  <files>apps/portal/src/hooks/useObsidianVault.ts</files>
  <action>
    Create apps/portal/src/hooks/useObsidianVault.ts:

    ```typescript
    /**
     * Obsidian Vault Hook
     *
     * React hook for managing Obsidian vault state.
     */

    import { useState, useEffect } from 'react';
    import {
      openVault,
      getVaultConfig,
      clearVaultConfig,
      isSupported,
      type VaultHandle,
      type VaultConfig,
    } from '@/lib/vaultIntegration';

    export function useObsidianVault() {
      const [vault, setVault] = useState<VaultHandle | null>(null);
      const [config, setConfig] = useState<VaultConfig | null>(null);
      const [isOpening, setIsOpening] = useState(false);
      const [error, setError] = useState<string | null>(null);
      const [supported, setSupported] = useState(true);

      useEffect(() => {
        // Check API support
        setSupported(isSupported());

        // Load saved config
        const savedConfig = getVaultConfig();
        if (savedConfig) {
          setConfig(savedConfig);
        }
      }, []);

      const open = async () => {
        if (!supported) {
          setError('Seu navegador não suporta acesso a arquivos locais. Use Chrome ou Edge.');
          return null;
        }

        setIsOpening(true);
        setError(null);

        try {
          const vaultHandle = await openVault();
          if (vaultHandle) {
            setVault(vaultHandle);
            setConfig({
              path: vaultHandle.path,
              lastAccess: new Date().toISOString(),
            });
            return vaultHandle;
          }
          return null;
        } catch (err) {
          setError('Falha ao abrir vault. Tente novamente.');
          console.error(err);
          return null;
        } finally {
          setIsOpening(false);
        }
      };

      const clear = () => {
        clearVaultConfig();
        setVault(null);
        setConfig(null);
      };

      return {
        vault,
        config,
        isOpening,
        error,
        supported,
        open,
        clear,
      };
    }
    ```
  </action>
  <verify>useObsidianVault.ts exports useObsidianVault hook</verify>
  <done>Obsidian vault hook</done>
</task>

<task type="auto">
  <name>Create VaultPathSelector component</name>
  <files>apps/portal/src/components/VaultPathSelector.tsx</files>
  <action>
    Create apps/portal/src/components/VaultPathSelector.tsx:

    ```typescript
    /**
     * Vault Path Selector Component
     *
     * UI for selecting and managing Obsidian vault path.
     */

    import { useObsidianVault } from '@/hooks/useObsidianVault';

    export interface VaultPathSelectorProps {
      onVaultSelected?: (vaultPath: string) => void;
    }

    export function VaultPathSelector({ onVaultSelected }: VaultPathSelectorProps) {
      const { vault, config, isOpening, error, supported, open, clear } = useObsidianVault();

      const handleOpenVault = async () => {
        const vaultHandle = await open();
        if (vaultHandle && onVaultSelected) {
          onVaultSelected(vaultHandle.path);
        }
      };

      const handleClear = () => {
        clear();
        onVaultSelected?.('');
      };

      if (!supported) {
        return (
          <div className="p-4 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg">
            <div className="flex items-start gap-3">
              <svg className="w-5 h-5 text-yellow-600 dark:text-yellow-400 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
              </svg>
              <div>
                <p className="text-sm font-medium text-yellow-800 dark:text-yellow-300">
                  Acesso a arquivos locais não suportado
                </p>
                <p className="text-xs text-yellow-700 dark:text-yellow-400 mt-1">
                  Seu navegador não suporta acesso a arquivos locais. Use Chrome ou Edge no macOS, Windows, ou Linux.
                </p>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="vault-path-selector space-y-4">
          <div>
            <label className="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
              Vault do Obsidian
            </label>
            <p className="text-xs text-gray-500 dark:text-gray-400 mb-3">
              Selecione seu vault do Obsidian para acessar arquivos locais e preservar links.
            </p>
          </div>

          {config ? (
            <div className="p-4 bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg">
              <div className="flex items-center justify-between">
                <div className="flex items-center gap-3">
                  <svg className="w-5 h-5 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                  <div>
                    <p className="text-sm font-medium text-gray-900 dark:text-white">
                      {config.path}
                    </p>
                    <p className="text-xs text-gray-500 dark:text-gray-400">
                      Conectado em {new Date(config.lastAccess).toLocaleDateString('pt-BR')}
                    </p>
                  </div>
                </div>

                <button
                  onClick={handleClear}
                  className="text-sm text-red-600 dark:text-red-400 hover:underline"
                >
                  Remover
                </button>
              </div>
            </div>
          ) : (
            <div className="p-4 bg-gray-50 dark:bg-gray-900 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg text-center">
              <svg className="w-8 h-8 text-gray-400 mx-auto mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" />
              </svg>
              <p className="text-sm text-gray-600 dark:text-gray-400 mb-3">
                Nenhum vault selecionado
              </p>
              <button
                onClick={handleOpenVault}
                disabled={isOpening}
                className="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
              >
                {isOpening ? 'Abrindo...' : 'Selecionar Vault'}
              </button>
            </div>
          )}

          {error && (
            <div className="p-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg">
              <p className="text-sm text-red-600 dark:text-red-400">{error}</p>
            </div>
          )}

          <div className="p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg">
            <p className="text-xs text-blue-800 dark:text-blue-300">
              <strong>Nota:</strong> Os arquivos são lidos diretamente do seu computador. Nada é enviado para servidores externos. Os arquivos ficam salvos localmente no seu vault.
            </p>
          </div>
        </div>
      );
    }

    export default VaultPathSelector;
    ```
  </action>
  <verify>VaultPathSelector.tsx shows vault selector UI with support detection</verify>
  <done>Vault path selector component</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete Obsidian vault integration</what-built>
  <how-to-verify>
    1. Start portal: `cd apps/portal && bun run dev`

    2. Test vault selection (requires Chrome or Edge):
       - Open page with VaultPathSelector component
       - Click "Selecionar Vault" button
       - Verify folder picker opens
       - Select an Obsidian vault folder
       - Verify vault name displays with green success indicator
       - Verify "Conectado em [date]" shows

    3. Test persistence:
       - Refresh page
       - Verify vault selection persists

    4. Test clear:
       - Click "Remover" button
       - Verify vault is cleared
       - Verify "Nenhum vault selecionado" shows

    5. Test browser compatibility (optional):
       - Open in Firefox/Safari
       - Verify "Acesso a arquivos locais não suportado" message shows

    Expected outcomes:
    - Vault picker opens in Chrome/Edge
    - Selected vault persists in localStorage
    - Error message shows in unsupported browsers
  </how-to-verify>
  <resume-signal>Type "approved" if vault integration works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] vaultIntegration.ts exports openVault, listVaultFiles, readVaultFile, isSupported, getObsidianUri
- [ ] File System Access API support detection
- [ ] Recursive directory scanning skips .obsidian
- [ ] VaultPathSelector component created
- [ ] useObsidianVault hook for state management
- [ ] localStorage persistence for vault config
- [ ] Error handling for unsupported browsers
- [ ] obsidian:// URI generation
</verification>

<success_criteria>
1. Users can select Obsidian vault (COLL-05)
2. Local files accessible via File System Access API
3. Obsidian links preserved (via obsidian:// URI)
4. Vault config persists in localStorage
5. Browser compatibility detection
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-collaboration/plans/04-04-SUMMARY.md`
</output>

---

**Plan created:** 2026-02-07
**Estimated duration:** 30 min
**Complexity:** Medium (File System Access API, recursive scanning, permissions, browser compatibility)

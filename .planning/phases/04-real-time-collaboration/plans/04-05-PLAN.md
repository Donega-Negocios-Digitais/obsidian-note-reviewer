---
phase: 04-real-time-collaboration
plan: 05
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/portal/src/lib/slugGenerator.ts
  - apps/portal/src/components/ShareButton.tsx
  - apps/portal/src/pages/ReviewPage.tsx
  - apps/portal/src/lib/supabase/sharing.ts
autonomous: false

user_setup:
  - service: supabase
    why: "Store share_hash and is_public flags for shared documents"
    env_vars:
      - name: SUPABASE_URL
        source: "Supabase Dashboard -> Project Settings -> API"
      - name: SUPABASE_ANON_KEY
        source: "Supabase Dashboard -> Project Settings -> API"

must_haves:
  truths:
    - "Users can generate shareable link via ShareButton"
    - "Slug is generated using NanoID (URL-friendly, unique)"
    - "Share link format: /shared/{slug}"
    - "Shared documents are marked with is_public=true in Supabase"
    - "Share button copies link to clipboard"
  artifacts:
    - path: "apps/portal/src/lib/slugGenerator.ts"
      provides: "NanoID-based slug generation for shareable links"
      exports: ["generateSlug", "isSlugValid"]
      min_lines: 30
    - path: "apps/portal/src/components/ShareButton.tsx"
      provides: "Share button with copy-to-clipboard functionality"
      min_lines: 60
    - path: "apps/portal/src/lib/supabase/sharing.ts"
      provides: "Supabase functions for creating and retrieving shared documents"
      exports: ["createSharedLink", "getDocumentBySlug"]
      min_lines: 80
  key_links:
    - from: "apps/portal/src/components/ShareButton.tsx"
      to: "apps/portal/src/lib/slugGenerator.ts"
      via: "import"
      pattern: "generateSlug"
    - from: "apps/portal/src/components/ShareButton.tsx"
      to: "apps/portal/src/lib/supabase/sharing.ts"
      via: "import"
      pattern: "createSharedLink"
---

<objective>
Implement shareable link system with NanoID slug generation, enabling users to generate unique, friendly URLs for sharing documents with guests.

**Purpose:** Deliver COLL-03 requirement - shareable links with unique slugs.

**Output:** Complete sharing system with share button and slug-based routing.
</objective>

<execution_context>
@C:\Users\Alex\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Alex\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/phases/04-real-time-collaboration/04-CONTEXT.md
@.planning/phases/04-real-time-collaboration/04-RESEARCH.md
@.planning/phases/04-real-time-collaboration/plans/04-03-PLAN.md

User locked decisions (from CONTEXT.md Deferred Ideas):
- **Sistema de compartilhamento** foi adiado, mas COLL-03 é um requisito CORE desta fase

Research recommendations:
- Use NanoID 5.0.9 for URL-friendly unique IDs
- Share link format: /shared/{slug}
- Store is_public flag in Supabase

Existing from 04-01:
- Liveblocks integration for presence
- CollaborationRoom for real-time features

Existing from 04-03:
- SharedDocument.tsx page with /shared/:slug route (needs slug source)
</context>

<tasks>

<task type="auto">
  <name>Add NanoID dependency and create slug generator</name>
  <files>apps/portal/package.json, apps/portal/src/lib/slugGenerator.ts</files>
  <action>
    1. Add to apps/portal/package.json dependencies:
    ```json
    "nanoid": "^5.0.9"
    ```

    2. Install: cd apps/portal && bun install

    3. Create apps/portal/src/lib/slugGenerator.ts:

    ```typescript
    /**
     * Slug Generator
     *
     * URL-friendly unique ID generation using NanoID.
     * Per COLL-03: "Plan owner can generate unique, friendly URL for sharing"
     */

    import { nanoid } from "nanoid";

    const SLUG_LENGTH = 10; // 10 chars = ~4.5 billion combinations
    const SLUG_ALPHABET = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";

    /**
     * Generate unique shareable slug
     * Format: /shared/{slug} where slug is 10-char URL-friendly string
     */
    export function generateSlug(): string {
      return nanoid(SLUG_LENGTH);
    }

    /**
     * Validate slug format (for security)
     */
    export function isSlugValid(slug: string): boolean {
      return /^[a-zA-Z0-9]{10}$/.test(slug);
    }

    /**
     * Generate full share URL
     */
    export function getShareUrl(slug: string): string {
      const baseUrl = window.location.origin;
      return `${baseUrl}/shared/${slug}`;
    }
    ```

    4. Update apps/portal/src/lib/supabase/client.ts (or existing supabase client) to add sharing types:
    ```typescript
    export interface SharedDocument {
      id: string;
      document_id: string;
      slug: string;
      is_public: boolean;
      created_at: string;
    }
    ```
  </action>
  <verify>slugGenerator.ts exports generateSlug, isSlugValid, getShareUrl; nanoid@5.0.9 installed</verify>
  <done>Slug generator with NanoID</done>
</task>

<task type="auto">
  <name>Create Supabase sharing functions</name>
  <files>apps/portal/src/lib/supabase/sharing.ts</files>
  <action>
    Create apps/portal/src/lib/supabase/sharing.ts:

    ```typescript
    /**
     * Sharing Functions
     *
     * Supabase operations for shareable links.
     * Stores share_hash (slug) and marks documents as public.
     */

    import { supabase } from "./client";
    import { generateSlug, isSlugValid } from "@/lib/slugGenerator";
    import type { SharedDocument } from "./client";

    /**
     * Create shareable link for a document
     * Returns: slug for the shared document
     */
    export async function createSharedLink(documentId: string): Promise<{ slug: string; url: string }> {
      // Generate unique slug
      const slug = generateSlug();

      // Check if slug already exists (collision handling)
      const { data: existing } = await supabase
        .from("shared_documents")
        .select("slug")
        .eq("slug", slug)
        .single();

      if (existing) {
        // Retry with new slug (extremely rare collision)
        return createSharedLink(documentId);
      }

      // Create shared document record
      const { error } = await supabase
        .from("shared_documents")
        .insert({
          document_id: documentId,
          slug: slug,
          is_public: true,
          created_at: new Date().toISOString(),
        });

      if (error) {
        console.error("Failed to create shared link:", error);
        throw new Error("Could not create shareable link");
      }

      return {
        slug,
        url: `${window.location.origin}/shared/${slug}`,
      };
    }

    /**
     * Get document by slug (for SharedDocument page)
     */
    export async function getDocumentBySlug(slug: string) {
      if (!isSlugValid(slug)) {
        throw new Error("Invalid slug format");
      }

      const { data, error } = await supabase
        .from("shared_documents")
        .select(`
          *,
          document:documents(*)
        `)
        .eq("slug", slug)
        .eq("is_public", true)
        .single();

      if (error || !data) {
        throw new Error("Document not found or link expired");
      }

      return data;
    }

    /**
     * Check if document is already shared
     */
    export async function getExistingShare(documentId: string): Promise<string | null> {
      const { data } = await supabase
        .from("shared_documents")
        .select("slug")
        .eq("document_id", documentId)
        .eq("is_public", true)
        .single();

      return data?.slug || null;
    }
    ```

    Note: This assumes Supabase tables exist. Migration to be created separately:
    ```sql
    CREATE TABLE shared_documents (
      id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
      document_id UUID NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
      slug TEXT UNIQUE NOT NULL,
      is_public BOOLEAN DEFAULT true,
      created_at TIMESTAMPTZ DEFAULT NOW()
    );

    CREATE INDEX idx_shared_documents_slug ON shared_documents(slug);
    CREATE INDEX idx_shared_documents_document_id ON shared_documents(document_id);
    ```
  </action>
  <verify>sharing.ts exports createSharedLink, getDocumentBySlug, getExistingShare</verify>
  <done>Supabase sharing functions</done>
</task>

<task type="auto">
  <name>Create ShareButton component</name>
  <files>apps/portal/src/components/ShareButton.tsx</files>
  <action>
    Create apps/portal/src/components/ShareButton.tsx:

    ```typescript
    /**
     * Share Button Component
     *
     * Generates shareable link and copies to clipboard.
     * Per COLL-03: "Plan owner can generate unique, friendly URL for sharing"
     */

    import { useState } from "react";
    import { createSharedLink, getExistingShare, getShareUrl } from "@/lib/supabase/sharing";

    export interface ShareButtonProps {
      documentId: string;
    }

    export function ShareButton({ documentId }: ShareButtonProps) {
      const [loading, setLoading] = useState(false);
      const [copied, setCopied] = useState(false);
      const [shareUrl, setShareUrl] = useState<string | null>(null);

      const handleShare = async () => {
        setLoading(true);

        try {
          // Check if already shared
          const existingSlug = await getExistingShare(documentId);

          let url: string;
          if (existingSlug) {
            // Use existing share
            url = getShareUrl(existingSlug);
          } else {
            // Create new share
            const result = await createSharedLink(documentId);
            url = result.url;
          }

          // Copy to clipboard
          await navigator.clipboard.writeText(url);
          setShareUrl(url);
          setCopied(true);

          // Reset copied state after 2 seconds
          setTimeout(() => setCopied(false), 2000);
        } catch (error) {
          console.error("Failed to share:", error);
        } finally {
          setLoading(false);
        }
      };

      return (
        <button
          onClick={handleShare}
          disabled={loading}
          className="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-lg hover:bg-blue-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors"
        >
          {loading ? (
            <>
              <svg className="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" />
                <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
              </svg>
              Gerando link...
            </>
          ) : copied ? (
            <>
              <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M5 13l4 4L19 7" />
              </svg>
              Link copiado!
            </>
          ) : (
            <>
              <svg className="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
              </svg>
              Compartilhar
            </>
          )}
        </button>
      );
    }

    export default ShareButton;
    ```
  </action>
  <verify>ShareButton.tsx generates link and copies to clipboard</verify>
  <done>Share button component</done>
</task>

<task type="auto">
  <name>Integrate ShareButton into review page</name>
  <files>apps/portal/src/pages/ReviewPage.tsx</files>
  <action>
    Add ShareButton to the document header/toolbar:

    In your ReviewPage component (or wherever documents are viewed):

    ```typescript
    import { ShareButton } from "@/components/ShareButton";

    // In the header/toolbar section, add:
    <div className="flex items-center gap-2">
      {/* Existing header content */}
      <ShareButton documentId={document.id} />
    </div>
    ```

    If using CollaborationRoom from 04-01, ensure ShareButton is outside or positioned appropriately in the UI.
  </action>
  <verify>ShareButton appears in document view with documentId prop</verify>
  <done>ShareButton integrated into review page</done>
</task>

<task type="auto">
  <name>Update SharedDocument page to use slug-based fetch</name>
  <files>apps/portal/src/pages/SharedDocument.tsx</files>
  <action>
    Update the fetchDocument function in SharedDocument.tsx to use actual Supabase call:

    Find the mock data section and replace with:

    ```typescript
    import { getDocumentBySlug } from "@/lib/supabase/sharing";

    // In the useEffect fetchDocument function:
    const fetchDocument = async () => {
      try {
        setLoading(true);

        // Use actual Supabase fetch
        const sharedData = await getDocumentBySlug(slug);

        setDocument({
          id: sharedData.document_id,
          title: sharedData.document.title,
          content: sharedData.document.content,
          annotations: sharedData.document.annotations || [],
          createdAt: sharedData.created_at,
        });
      } catch (err) {
        setError("Documento não encontrado ou link expirou");
        console.error("Failed to fetch shared document:", err);
      } finally {
        setLoading(false);
      }
    };
    ```

    This replaces the TODO mock data section from Plan 04-03.
  </action>
  <verify>SharedDocument uses getDocumentBySlug from sharing.ts</verify>
  <done>SharedDocument page updated with real slug fetch</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete shareable links system</what-built>
  <how-to-verify>
    1. Ensure Supabase tables exist (run migration if needed):
       ```sql
       CREATE TABLE IF NOT EXISTS shared_documents (
         id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
         document_id UUID NOT NULL REFERENCES documents(id) ON DELETE CASCADE,
         slug TEXT UNIQUE NOT NULL,
         is_public BOOLEAN DEFAULT true,
         created_at TIMESTAMPTZ DEFAULT NOW()
       );

       CREATE INDEX IF NOT EXISTS idx_shared_documents_slug ON shared_documents(slug);
       ```

    2. Start portal: cd apps/portal && bun run dev

    3. Open a document in review view

    4. Click "Compartilhar" button:
       - Verify button shows "Gerando link..." state
       - Verify button changes to "Link copiado!"
       - Verify clipboard contains URL like http://localhost:5173/shared/AbCd1234Ef

    5. Open incognito window and paste the share URL:
       - Verify SharedDocument page loads
       - Verify guest banner appears
       - Verify document content displays

    6. Click "Compartilhar" again on same document:
       - Verify reuses same slug (doesn't create duplicate)

    Expected outcomes:
    - Share button generates unique NanoID slug
    - Link copies to clipboard
    - /shared/{slug} route works for guests
    - Same document reuses existing slug
  </how-to-verify>
  <resume-signal>Type "approved" if sharing works, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] nanoid@5.0.9 installed
- [ ] slugGenerator.ts generates 10-char URL-friendly slugs
- [ ] sharing.ts has createSharedLink, getDocumentBySlug, getExistingShare
- [ ] ShareButton component copies link to clipboard
- [ ] ShareButton integrated into review page
- [ ] SharedDocument uses getDocumentBySlug (not mock data)
- [ ] E2E test: share → copy → open in incognito works
</verification>

<success_criteria>
1. Shareable links generated via ShareButton (COLL-03)
2. Unique slugs using NanoID (URL-friendly)
3. /shared/{slug} route works for guests
4. Link copies to clipboard
5. Slug reuse on subsequent shares
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-collaboration/plans/04-05-SUMMARY.md`
</output>

---

**Plan created:** 2026-02-07
**Estimated duration:** 35 min
**Complexity:** Medium (NanoID, Supabase operations, clipboard API, share UX)

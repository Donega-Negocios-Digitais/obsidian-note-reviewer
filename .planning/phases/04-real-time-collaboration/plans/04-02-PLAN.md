---
phase: 04-real-time-collaboration
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/portal/src/components/collaboration/Cursor.tsx
  - apps/portal/src/components/collaboration/LiveCursors.tsx
  - apps/portal/src/hooks/useCursorTracking.ts
autonomous: false

must_haves:
  truths:
    - "Users can see real-time cursors of other users"
    - "Cursors have consistent colors from username hash"
    - "Cursor shows name tooltip on hover"
    - "Inactive cursors hide after 5 seconds (Claude's discretion)"
    - "Text selection shows colored highlight"
  artifacts:
    - path: "apps/portal/src/components/collaboration/Cursor.tsx"
      provides: "Individual cursor component with tooltip"
      min_lines: 60
    - path: "apps/portal/src/components/collaboration/LiveCursors.tsx"
      provides: "Container rendering all other users' cursors"
      min_lines: 50
    - path: "apps/portal/src/hooks/useCursorTracking.ts"
      provides: "Hook for tracking cursor position and inactivity"
      min_lines: 70
  key_links:
    - from: "apps/portal/src/components/collaboration/LiveCursors.tsx"
      to: "apps/portal/src/components/collaboration/Cursor.tsx"
      via: "import"
      pattern: "Cursor"
    - from: "apps/portal/src/components/collaboration/LiveCursors.tsx"
      to: "apps/portal/src/lib/cursor-colors.ts"
      via: "import"
      pattern: "getCursorColor"
    - from: "apps/portal/src/hooks/useCursorTracking.ts"
      to: "@liveblocks/react"
      via: "import"
      pattern: "useMyPresence"
---

<objective>
Implement real-time cursor tracking with colored indicators, tooltips, and inactivity timeout, enabling users to see where others are focusing in the document.

**Purpose:** Deliver COLL-02 requirement - real-time cursors and selection highlighting.

**Output:** Complete cursor tracking system with Liveblocks presence.
</objective>

<execution_context>
@C:\Users\Alex\.claude\get-shit-done\workflows\execute-plan.md
@C:\Users\Alex\.claude\get-shit-done\templates\summary.md
</execution_context>

<context>
@.planning/phases/04-real-time-collaboration/04-CONTEXT.md
@.planning/phases/04-real-time-collaboration/04-RESEARCH.md
@.planning/phases/04-real-time-collaboration/plans/04-01-PLAN.md

User locked decisions (from CONTEXT.md):
- **Cores dos cursores**: Gerada automaticamente por usuario (hash do nome -> cor unica)
- **Visual do cursor**: Cursor + highlight (fundo colorido no texto selecionado)
- **Nome associado**: Tooltip flutuante acima do cursor
- **Comportamento quando inativo**: Esconder cursor apos X segundos de inatividade (Claude's discretion: 5 segundos per RESEARCH.md)

Research recommendations:
- Use Liveblocks useMyPresence for broadcasting cursor position
- Implement inactivity timeout (5 seconds recommended)
- Show cursor + name label
- Selection highlighting with background color

Existing from 04-01:
- cursor-colors.ts with color-hash library
- RoomProvider for Liveblocks rooms
- PresenceList component
</context>

<tasks>

<task type="auto">
  <name>Create Cursor component with tooltip</name>
  <files>apps/portal/src/components/collaboration/Cursor.tsx</files>
  <action>
    Create apps/portal/src/components/collaboration/Cursor.tsx:

    ```typescript
    /**
     * Cursor Component
     *
     * Renders a single user's cursor with name tooltip.
     * Per CONTEXT.md: "Visual do cursor: Cursor + highlight (fundo colorido no texto selecionado)"
     * Per CONTEXT.md: "Nome associado: Tooltip flutuante acima do cursor"
     */

    import { memo } from "react";

    export interface CursorProps {
      x: number;
      y: number;
      color: string;
      name: string;
      isTyping?: boolean;
      selection?: {
        start: { x: number; y: number };
        end: { x: number; y: number };
      };
    }

    export const Cursor = memo(({ x, y, color, name, isTyping, selection }: CursorProps) => {
      return (
        <g
          transform={`translate(${x}, ${y})`}
          className="transition-transform duration-75 ease-out"
          style={{ pointerEvents: "none" }}
        >
          {/* Cursor pointer */}
          <path
            d="M0 0 L12 12 L7 12 L4 16 Z"
            fill={color}
            strokeWidth={1}
            stroke="white"
          />

          {/* Name label/tooltip */}
          <foreignObject x={12} y={0} width={200} height={24} style={{ pointerEvents: "none" }}>
            <div
              className="px-2 py-0.5 text-xs font-medium text-white whitespace-nowrap rounded shadow-sm"
              style={{ backgroundColor: color }}
            >
              {name}
            </div>
          </foreignObject>

          {/* Selection highlight */}
          {selection && (
            <rect
              x={Math.min(selection.start.x, selection.end.x)}
              y={Math.min(selection.start.y, selection.end.y)}
              width={Math.abs(selection.end.x - selection.start.x)}
              height={Math.abs(selection.end.y - selection.start.y)}
              fill={color}
              fillOpacity={0.3}
            />
          )}
        </g>
      );
    });

    Cursor.displayName = "Cursor";
    ```
  </action>
  <verify>Cursor.tsx exports Cursor component with SVG rendering</verify>
  <done>Cursor component with tooltip</done>
</task>

<task type="auto">
  <name>Create LiveCursors component</name>
  <files>apps/portal/src/components/collaboration/LiveCursors.tsx</files>
  <action>
    Create apps/portal/src/components/collaboration/LiveCursors.tsx:

    ```typescript
    /**
     * Live Cursors Component
     *
     * Renders all other users' cursors in the document.
     */

    import { useOthers } from "@liveblocks/react";
    import { Cursor } from "./Cursor";
    import { getCursorColor } from "@/lib/cursor-colors";

    export function LiveCursors() {
      const others = useOthers();

      return (
        <svg
          className="absolute inset-0 w-full h-full pointer-events-none overflow-visible"
          style={{ zIndex: 1000 }}
        >
          {others
            .filter((other) => other.presence.cursor !== null)
            .map((other) => (
              <Cursor
                key={other.connectionId}
                x={(other.presence.cursor as { x: number }).x}
                y={(other.presence.cursor as { x: number; y: number }).y}
                color={getCursorColor(other.info.name as string)}
                name={other.info.name as string}
                isTyping={other.presence.isTyping as boolean | undefined}
                selection={other.presence.selection as CursorProps["selection"]}
              />
            ))}
        </svg>
      );
    }

    import type { CursorProps } from "./Cursor";
    ```
  </action>
  <verify>LiveCursors.tsx renders all active users' cursors</verify>
  <done>Live cursors container component</done>
</task>

<task type="auto">
  <name>Create useCursorTracking hook with inactivity timeout</name>
  <files>apps/portal/src/hooks/useCursorTracking.ts</files>
  <action>
    Create apps/portal/src/hooks/useCursorTracking.ts:

    ```typescript
    /**
     * Cursor Tracking Hook
     *
     * Tracks cursor position and manages inactivity timeout.
     * Per CONTEXT.md: "Comportamento quando inativo: Esconder cursor apos X segundos de inatividade"
     * Claude's discretion (per RESEARCH.md): 5 seconds
     */

    import { useEffect, useRef } from "react";
    import { useMyPresence } from "@liveblocks/react";

    const INACTIVE_TIMEOUT = 5000; // 5 seconds per RESEARCH.md recommendation

    export function useCursorTracking() {
      const [, updateMyPresence] = useMyPresence();
      const timeoutRef = useRef<NodeJS.Timeout>();

      useEffect(() => {
        const handleMouseMove = (e: MouseEvent) => {
          // Clear existing timeout
          if (timeoutRef.current) {
            clearTimeout(timeoutRef.current);
          }

          // Update cursor position
          updateMyPresence({
            cursor: {
              x: e.clientX,
              y: e.clientY,
            },
          });

          // Set new timeout for inactivity
          timeoutRef.current = setTimeout(() => {
            updateMyPresence({
              cursor: null,
            });
          }, INACTIVE_TIMEOUT);
        };

        // Add event listener
        window.addEventListener("mousemove", handleMouseMove);

        // Cleanup
        return () => {
          window.removeEventListener("mousemove", handleMouseMove);
          if (timeoutRef.current) {
            clearTimeout(timeoutRef.current);
          }
          // Clear cursor on unmount
          updateMyPresence({
            cursor: null,
          });
        };
      }, [updateMyPresence]);
    }

    /**
     * Hook for tracking text selection
     */
    export function useSelectionTracking() {
      const [, updateMyPresence] = useMyPresence();

      useEffect(() => {
        const handleSelection = () => {
          const selection = window.getSelection();
          if (selection && selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            const rects = range.getClientRects();

            if (rects.length > 0) {
              const firstRect = rects[0];
              const lastRect = rects[rects.length - 1];

              updateMyPresence({
                selection: {
                  start: { x: firstRect.left, y: firstRect.top },
                  end: { x: lastRect.right, y: lastRect.bottom },
                },
              });
            }
          } else {
            updateMyPresence({ selection: null });
          }
        };

        document.addEventListener("selectionchange", handleSelection);

        return () => {
          document.removeEventListener("selectionchange", handleSelection);
        };
      }, [updateMyPresence]);
    }
    ```
  </action>
  <verify>useCursorTracking.ts exports useCursorTracking and useSelectionTracking</verify>
  <done>Cursor tracking hook with inactivity timeout</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete real-time cursor tracking</what-built>
  <how-to-verify>
    1. Ensure 04-01 is complete (Liveblocks integration works)

    2. Start portal: `cd apps/portal && bun run dev`

    3. Open same document in two browser windows (incognito for different session)

    4. Verify cursor behavior:
       - Move mouse in window 1 → cursor appears in window 2
       - Cursor shows correct color (from color-hash)
       - Cursor shows name tooltip
       - Stop moving mouse → cursor disappears after ~5 seconds
       - Move again → cursor reappears in other window
       - Select text in window 1 → highlight appears in window 2

    Expected outcomes:
    - Cursors appear in real-time (minimal lag)
    - Colors are consistent per user (color-hash)
    - Name tooltip shows above cursor
    - Inactivity timeout ~5 seconds
    - Text selection shows colored highlight
  </how-to-verify>
  <resume-signal>Type "approved" if cursors work, or describe issues</resume-signal>
</task>

</tasks>

<verification>
- [ ] Cursor component renders SVG cursor with name tooltip
- [ ] LiveCursors component renders all other users' cursors
- [ ] useCursorTracking broadcasts cursor position via useMyPresence
- [ ] Inactivity timeout hides cursor after 5 seconds
- [ ] Text selection shows colored highlight
- [ ] Cursor colors use color-hash library
- [ ] E2E test confirms cursor tracking in multiple windows
</verification>

<success_criteria>
1. Real-time cursors show user positions (COLL-02)
2. Cursor colors consistent from username hash
3. Name tooltip shows above cursor
4. Inactivity timeout implemented (5 seconds)
5. Text selection highlighting works
</success_criteria>

<output>
After completion, create `.planning/phases/04-real-time-collaboration/plans/04-02-SUMMARY.md`
</output>

---

**Plan created:** 2026-02-07
**Estimated duration:** 30 min
**Complexity:** Medium (Liveblocks presence, SVG rendering, inactivity timeout)
